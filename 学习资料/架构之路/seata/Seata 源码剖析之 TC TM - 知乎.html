<!DOCTYPE html>
<html data-theme="light" data-react-helmet="data-theme" lang="zh"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Seata 源码剖析之 TC TM - 知乎</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="google-site-verification" content="FTeR0c8arOPKh8c5DYh_9uu98_zJbaWw53J-Sch9MTg"><meta data-react-helmet="true" name="keywords" content="分布式事务,Java,源码阅读"><meta data-react-helmet="true" name="description" content="引言书接上文，之前我们介绍 Seata 的理论思想，接下来，我们着重剖析一下 Seata 中的关键组件。 源码剖析Seata 整体的代码比较多, 为了避免代码堆砌影响读感, 这里我只介绍核心内容, 我会先介绍 Seata 中的核心组…"><meta data-react-helmet="true" property="og:title" content="Seata 源码剖析之 TC TM"><meta data-react-helmet="true" property="og:url" content="https://zhuanlan.zhihu.com/p/87100741"><meta data-react-helmet="true" property="og:description" content="引言书接上文，之前我们介绍 Seata 的理论思想，接下来，我们着重剖析一下 Seata 中的关键组件。 源码剖析Seata 整体的代码比较多, 为了避免代码堆砌影响读感, 这里我只介绍核心内容, 我会先介绍 Seata 中的核心组…"><meta data-react-helmet="true" property="og:image" content=""><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="og:site_name" content="知乎专栏"><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.67c7b278.png"><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.67c7b278.png" sizes="152x152"><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-120.b3e6278d.png" sizes="120x120"><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-76.7a750095.png" sizes="76x76"><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-60.a4a761d4.png" sizes="60x60"><link rel="shortcut icon" type="image/x-icon" href="https://static.zhihu.com/static/favicon.ico"><link rel="search" type="application/opensearchdescription+xml" href="https://static.zhihu.com/static/search.xml" title="知乎"><link rel="dns-prefetch" href="https://static.zhimg.com/"><link rel="dns-prefetch" href="https://pic1.zhimg.com/"><link rel="dns-prefetch" href="https://pic2.zhimg.com/"><link rel="dns-prefetch" href="https://pic3.zhimg.com/"><link rel="dns-prefetch" href="https://pic4.zhimg.com/"><style>
.u-safeAreaInset-top {
  height: constant(safe-area-inset-top) !important;
  height: env(safe-area-inset-top) !important;
  
}
.u-safeAreaInset-bottom {
  height: constant(safe-area-inset-bottom) !important;
  height: env(safe-area-inset-bottom) !important;
  
}
</style><link href="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column.css" rel="stylesheet"><script type="text/javascript" async="" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/analytics.js" nonce=""></script><script defer="defer" crossorigin="anonymous" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/init.js" data-sentry-config="{&quot;dsn&quot;:&quot;https://2d8d764432cc4f6fb3bc78ab9528299d@crash2.zhihu.com/1224&quot;,&quot;sampleRate&quot;:0.1,&quot;release&quot;:&quot;725-a5d8e5df&quot;,&quot;ignoreErrorNames&quot;:[&quot;NetworkError&quot;,&quot;SecurityError&quot;],&quot;ignoreErrors&quot;:[&quot;origin message&quot;,&quot;Network request failed&quot;,&quot;Loading chunk&quot;,&quot;这个系统不支持该功能。&quot;,&quot;Can't find variable: webkit&quot;,&quot;Can't find variable: $&quot;,&quot;内存不足&quot;,&quot;out of memory&quot;,&quot;DOM Exception 18&quot;,&quot;The operation is insecure&quot;,&quot;[object Event]&quot;,&quot;[object FileError]&quot;,&quot;[object DOMError]&quot;,&quot;[object Object]&quot;,&quot;拒绝访问。&quot;,&quot;Maximum call stack size exceeded&quot;,&quot;UploadError&quot;,&quot;无法 fetch&quot;,&quot;draft-js&quot;,&quot;缺少 JavaScript 对象&quot;,&quot;componentWillEnter&quot;,&quot;componentWillLeave&quot;,&quot;componentWillAppear&quot;,&quot;getInlineStyleAt&quot;,&quot;getCharacterList&quot;],&quot;whitelistUrls&quot;:[&quot;static.zhihu.com&quot;]}"></script><style data-emotion-css="1cd9gw4">.css-1cd9gw4{margin-left:.3em;}</style><script charset="utf-8" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_006.js"></script><link rel="stylesheet" type="text/css" href="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_004.css"><script charset="utf-8" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column.js"></script><link rel="stylesheet" type="text/css" href="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_006.css"><script charset="utf-8" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_007.js"></script><link rel="stylesheet" type="text/css" href="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_003.css"><script charset="utf-8" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_004.js"></script><link rel="stylesheet" type="text/css" href="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_002.css"><script charset="utf-8" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_002.js"></script><style data-emotion="css"></style><link rel="stylesheet" type="text/css" href="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_005.css"><script charset="utf-8" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_005.js"></script></head><body class="WhiteBg-body" data-react-helmet="class"><img src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/logo.png" hidden=""><div id="root"><div class="App"><div class="LoadingBar"></div><main role="main" class="App-main"><div class="Post-content" data-zop-usertoken="{&quot;userToken&quot;:&quot;&quot;}" data-zop="{&quot;authorName&quot;:&quot;贝克街的流浪猫&quot;,&quot;itemId&quot;:87100741,&quot;title&quot;:&quot;Seata 源码剖析之 TC TM&quot;,&quot;type&quot;:&quot;article&quot;}" data-za-detail-view-path-module="PostItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;token&quot;:&quot;87100741&quot;}}}"><div class="ColumnPageHeader-Wrapper"><div><div class="Sticky ColumnPageHeader is-fixed" style="width: 1188px; top: 0px; left: 0px;"><div class="ColumnPageHeader-content"><a class="ZhihuLogoLink" href="https://www.zhihu.com/" aria-label="知乎"><svg viewBox="0 0 200 91" fill="#0084FF" width="64" height="30"><path d="M53.29 80.035l7.32.002 2.41 8.24 13.128-8.24h15.477v-67.98H53.29v67.978zm7.79-60.598h22.756v53.22h-8.73l-8.718 5.473-1.587-5.46-3.72-.012v-53.22zM46.818 43.162h-16.35c.545-8.467.687-16.12.687-22.955h15.987s.615-7.05-2.68-6.97H16.807c1.09-4.1 2.46-8.332 4.1-12.708 0 0-7.523 0-10.085 6.74-1.06 2.78-4.128 13.48-9.592 24.41 1.84-.2 7.927-.37 11.512-6.94.66-1.84.785-2.08 1.605-4.54h9.02c0 3.28-.374 20.9-.526 22.95H6.51c-3.67 0-4.863 7.38-4.863 7.38H22.14C20.765 66.11 13.385 79.24 0 89.62c6.403 1.828 12.784-.29 15.937-3.094 0 0 7.182-6.53 11.12-21.64L43.92 85.18s2.473-8.402-.388-12.496c-2.37-2.788-8.768-10.33-11.496-13.064l-4.57 3.627c1.363-4.368 2.183-8.61 2.46-12.71H49.19s-.027-7.38-2.372-7.38zm128.752-.502c6.51-8.013 14.054-18.302 14.054-18.302s-5.827-4.625-8.556-1.27c-1.874 2.548-11.51 15.063-11.51 15.063l6.012 4.51zm-46.903-18.462c-2.814-2.577-8.096.667-8.096.667s12.35 17.2 12.85 17.953l6.08-4.29s-8.02-11.752-10.83-14.33zM199.99 46.5c-6.18 0-40.908.292-40.953.292v-31.56c1.503 0 3.882-.124 7.14-.376 12.773-.753 21.914-1.25 27.427-1.504 0 0 3.817-8.496-.185-10.45-.96-.37-7.24 1.43-7.24 1.43s-51.63 5.153-72.61 5.64c.5 2.756 2.38 5.336 4.93 6.11 4.16 1.087 7.09.53 15.36.277 7.76-.5 13.65-.76 17.66-.76v31.19h-41.71s.88 6.97 7.97 7.14h33.73v22.16c0 4.364-3.498 6.87-7.65 6.6-4.4.034-8.15-.36-13.027-.566.623 1.24 1.977 4.496 6.035 6.824 3.087 1.502 5.054 2.053 8.13 2.053 9.237 0 14.27-5.4 14.027-14.16V53.93h38.235c3.026 0 2.72-7.432 2.72-7.432z" fill-rule="evenodd"></path></svg></a><i class="ColumnPageHeader-Line"></i><div class="ColumnPageHeader-Title"><div class="ColumnPageHeader-TitleName"><span class="ColumnPageHeader-TitleMeta">首发于</span><a class="ColumnLink ColumnPageHeader-TitleColumn" href="https://www.zhihu.com/column/c_1167429588711337985">贝贝猫技术分享</a></div></div><div class="ColumnPageHeader-Button"><button type="button" class="Button ColumnPageHeader-WriteButton Button--blue"><svg class="Zi Zi--EditSurround" fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M18.453 7.992l-1.833-1.65.964-.978a1.223 1.223 0 0 1 1.73-.012l.005.006a1.24 1.24 0 0 1 .007 1.748l-.873.886zm-1.178 1.194l-5.578 5.66-1.935.697a.393.393 0 0 1-.504-.504l.697-1.935 5.488-5.567 1.832 1.65zM7.58 5.848l5.654.006-1.539 1.991-3.666.012A1.02 1.02 0 0 0 7 8.868v7.993c0 .558.46 1.01 1.029 1.01l7.941-.01c.568 0 1.03-.453 1.03-1.012v-4.061l2-1.442v6.002c0 1.397-1.2 2.501-2.62 2.501H7.574C6.153 19.85 5 18.717 5 17.32V8.35c0-1.397 1.16-2.502 2.58-2.502z"></path></svg>写文章</button></div></div></div><div class="Sticky--holder" style="position: relative; inset: 0px; display: block; float: none; margin: 0px; height: 52px;"></div></div></div><article class="Post-Main Post-NormalMain" tabindex="-1"><header class="Post-Header"><h1 class="Post-Title">Seata 源码剖析之 TC TM</h1><div class="Post-Author"><div class="AuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="贝克街的流浪猫"><meta itemprop="image" content="https://pic1.zhimg.com/v2-862f47c1c2624aacea89180adb8398da_l.jpg?source=172ae18b"><meta itemprop="url" content="https://www.zhihu.com/people/beikejiedeliulangmao"><meta itemprop="zhihu:followerCount"><span class="UserLink AuthorInfo-avatarWrapper"><div class="Popover"><div id="Popover8-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover8-content"><a class="UserLink-link" data-za-detail-view-element_name="User" target="_blank" href="https://www.zhihu.com/people/beikejiedeliulangmao"><img class="Avatar Avatar--round AuthorInfo-avatar" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-862f47c1c2624aacea89180adb8398da_xs.jpg" srcset="https://pic1.zhimg.com/v2-862f47c1c2624aacea89180adb8398da_l.jpg?source=172ae18b 2x" alt="贝克街的流浪猫" width="38" height="38"></a></div></div></span><div class="AuthorInfo-content"><div class="AuthorInfo-head"><span class="UserLink AuthorInfo-name"><div class="Popover"><div id="Popover9-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover9-content"><a class="UserLink-link" data-za-detail-view-element_name="User" target="_blank" href="https://www.zhihu.com/people/beikejiedeliulangmao">贝克街的流浪猫</a></div></div></span></div><div class="AuthorInfo-detail"><div class="AuthorInfo-badge"><div class="ztext AuthorInfo-badgeText">公众号:bbm_share 分享技术经验</div></div></div></div></div></div><div><span class="Voters"><button type="button" class="Button Button--plain">3 人<!-- -->赞同了该文章</button></span></div></header><div class="Post-RichTextContainer"><div class="RichText ztext Post-RichText"><h2>引言</h2><p>书接上文，之前我们介绍 Seata 的理论思想，接下来，我们着重剖析一下 Seata 中的关键组件。 </p><h2>源码剖析</h2><p>Seata
 整体的代码比较多, 为了避免代码堆砌影响读感, 这里我只介绍核心内容, 我会先介绍 Seata 中的核心组件 TC 和 TM, 
然后再分别介绍一下 Seata 中现存的两个分支事务模式 AT、TCC 的完整流程，RM 的内容会根据分支事务模式的不同分别介绍。</p><h3>TC</h3><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-623b8c1089e907da1a854f5e01dc33ca_b.jpg" data-rawwidth="1252" data-rawheight="678" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb" width="1252" data-original="https://pic1.zhimg.com/v2-623b8c1089e907da1a854f5e01dc33ca_r.jpg"/></noscript><img src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-623b8c1089e907da1a854f5e01dc33ca_720w.jpg" data-rawwidth="1252" data-rawheight="678" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" data-original="https://pic1.zhimg.com/v2-623b8c1089e907da1a854f5e01dc33ca_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-623b8c1089e907da1a854f5e01dc33ca_b.jpg" data-lazy-status="ok" width="1252"></figure><p> Transaction Coordinator 整体的模块图如上所示: </p><p>- Coordinator Core: 在最下面的模块是事务协调器核心代码，主要用来处理事务协调的逻辑，如分支的注册, commit, rollback 等协调活动。 </p><p>- Store: 存储模块，用来将我们的数据持久化，防止重启或者宕机数据丢失。</p><p>- Discover: 服务注册/发现模块，用于将 Server 地址暴露给我们 Client。 </p><p>- Config: 用来存储和查找我们服务端的配置。 </p><p>- Lock: 锁模块，用于给 Seata 提供全局锁的功能。 </p><p>- Rpc: 用于和其他端通信。 </p><p>- HA-Cluster: 高可用集群，目前还没开源。为 Seata 提供可靠的高可用功能。</p><h3>Discover</h3><p>首先来讲讲比较基础的 Discover 模块，又称服务注册/发现模块。我们将 TC 启动之后，需要将自己的地址暴露给其他使用者 TM &amp; RM, 这部分工作就是由 Discover 模块实现的。</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RegistryService</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * The constant PREFIX_SERVICE_MAPPING.
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="n">PREFIX_SERVICE_MAPPING</span> <span class="o">=</span> <span class="s">"vgroup_mapping."</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * The constant PREFIX_SERVICE_ROOT.
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="n">PREFIX_SERVICE_ROOT</span> <span class="o">=</span> <span class="s">"service"</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * The constant CONFIG_SPLIT_CHAR.
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="n">CONFIG_SPLIT_CHAR</span> <span class="o">=</span> <span class="s">"."</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Register.
</span><span class="cm">     *
</span><span class="cm">     * @param address the address
</span><span class="cm">     * @throws Exception the exception
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">InetSocketAddress</span> <span class="n">address</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Unregister.
</span><span class="cm">     *
</span><span class="cm">     * @param address the address
</span><span class="cm">     * @throws Exception the exception
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">unregister</span><span class="o">(</span><span class="n">InetSocketAddress</span> <span class="n">address</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Subscribe.
</span><span class="cm">     *
</span><span class="cm">     * @param cluster  the cluster
</span><span class="cm">     * @param listener the listener
</span><span class="cm">     * @throws Exception the exception
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">subscribe</span><span class="o">(</span><span class="n">String</span> <span class="n">cluster</span><span class="o">,</span> <span class="n">T</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Unsubscribe.
</span><span class="cm">     *
</span><span class="cm">     * @param cluster  the cluster
</span><span class="cm">     * @param listener the listener
</span><span class="cm">     * @throws Exception the exception
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">unsubscribe</span><span class="o">(</span><span class="n">String</span> <span class="n">cluster</span><span class="o">,</span> <span class="n">T</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Lookup list.
</span><span class="cm">     *
</span><span class="cm">     * @param key the key
</span><span class="cm">     * @return the list
</span><span class="cm">     * @throws Exception the exception
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="nf">lookup</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Close.
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p>这个模块有个核心接口 RegistryService，如上图所示: </p><p>- register：TC 使用，进行服务注册。 </p><p>- unregister：TC 使用，一般在JVM关闭钩子，ShutdownHook中调用。 </p><p>- subscribe：TM RM 使用，注册监听事件，用来监听地址的变化。 </p><p>- unsubscribe：TM RM 使用，取消注册监听事件, 一般在JVM关闭钩子，ShutdownHook中调用。 </p><p>- lookup：TM RM使用，根据key查找服务地址列表。 - close：都可以使用，用于关闭Register资源。</p><p>如果需要添加自己定义的服务注册/发现，那么实现这个接口即可。截止目前在社区的不断开发推动下，已经有七种服务注册/发现，分别是consul，etcd3，sofa，redis, zk, nacos, eruka。下面简单介绍下 redis 的实现：</p><h3>register</h3><div class="highlight"><pre><code class="language-java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">InetSocketAddress</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 校验地址是否合法
</span><span class="c1"></span>    <span class="n">NetUtil</span><span class="o">.</span><span class="na">validAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">serverAddr</span> <span class="o">=</span> <span class="n">NetUtil</span><span class="o">.</span><span class="na">toStringAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
    <span class="c1">// 获取 Redis 的实例
</span><span class="c1"></span>    <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 将地址注册到当前 Redis 上面。
</span><span class="c1"></span>        <span class="n">jedis</span><span class="o">.</span><span class="na">hset</span><span class="o">(</span><span class="n">getRedisRegistryKey</span><span class="o">(),</span> <span class="n">serverAddr</span><span class="o">,</span> <span class="n">ManagementFactory</span><span class="o">.</span><span class="na">getRuntimeMXBean</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
        <span class="c1">// 发送注册成功的通知
</span><span class="c1"></span>        <span class="n">jedis</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="n">getRedisRegistryKey</span><span class="o">(),</span> <span class="n">serverAddr</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">RedisListener</span><span class="o">.</span><span class="na">REGISTER</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>流程如下: 1. 校验地址是否合法 2. 获取 Redis 的实例，然后将地址注册到当前 Redis 上面。 3. 发送注册成功的通知</p><p>unregister接口类似，就是反方向操作, 这里不做详解。</p><h3>lookup</h3><div class="highlight"><pre><code class="language-java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="nf">lookup</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigurationFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
    <span class="c1">// 获取当前 clusterName 名字
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">clusterName</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getConfig</span><span class="o">(</span><span class="n">PREFIX_SERVICE_ROOT</span> <span class="o">+</span> <span class="n">CONFIG_SPLIT_CHAR</span> <span class="o">+</span> <span class="n">PREFIX_SERVICE_MAPPING</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">clusterName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 判断当前 cluster 是否已经获取过了，如果获取过就从map中取
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">LISTENER_SERVICE_MAP</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">clusterName</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// 从 Redis 拿到地址数据，将其转换成我们所需要的
</span><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">hgetAll</span><span class="o">(</span><span class="n">getRedisRegistryKey</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">instances</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">instances</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="n">newAddressSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">instance</span> <span class="o">:</span> <span class="n">instances</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">serverAddr</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
                <span class="n">newAddressSet</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">toInetSocketAddress</span><span class="o">(</span><span class="n">serverAddr</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">CLUSTER_ADDRESS_MAP</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">clusterName</span><span class="o">,</span> <span class="n">newAddressSet</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 将数据变更的 Listener 注册到 Redis
</span><span class="c1"></span>        <span class="n">subscribe</span><span class="o">(</span><span class="n">clusterName</span><span class="o">,</span> <span class="k">new</span> <span class="n">RedisListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEvent</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">msgr</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"-"</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">serverAddr</span> <span class="o">=</span> <span class="n">msgr</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
                <span class="n">String</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">msgr</span><span class="o">[</span><span class="n">1</span><span class="o">];</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="n">RedisListener</span><span class="o">.</span><span class="na">REGISTER</span><span class="o">:</span>
                        <span class="n">CLUSTER_ADDRESS_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clusterName</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">toInetSocketAddress</span><span class="o">(</span><span class="n">serverAddr</span><span class="o">));</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="n">RedisListener</span><span class="o">.</span><span class="na">UN_REGISTER</span><span class="o">:</span>
                        <span class="n">CLUSTER_ADDRESS_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clusterName</span><span class="o">).</span><span class="na">remove</span><span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">toInetSocketAddress</span><span class="o">(</span><span class="n">serverAddr</span><span class="o">));</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="n">ShouldNeverHappenException</span><span class="o">(</span><span class="s">"unknown redis msg:"</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">CLUSTER_ADDRESS_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clusterName</span><span class="o">));</span>
<span class="o">}</span></code></pre></div><p>订阅的过程如下: 1. 获取当前 
clusterName 名字 2. 判断当前 cluster 是否已经获取过了，如果获取过就从map中取。 3. 从 Redis 
拿到地址数据，将其转换成我们所需要的数据。 4. 将数据变动的 Listener 注册到 Redis</p><p>其实这里面有个问题, 
如果获取了服务器列表, 但是还没来得及注册订阅时, 发生了服务器列表变化, 那么客户端会感知不到, 但是这个问题在 Redis 
中确实没有什么好的办法解决, 毕竟 Redis 没有提供机制来解决这个问题。但是 etcd3 中是有机制来解决的, 
获取数据时能拿到当时的版本号, 然后订阅时从该版本号开始即可。然后我看了一下基于 etcd3 的 <code>RegistryService</code> 实现, 发现它并没有使用该机制。于是我提了一个 <a href="https://link.zhihu.com/?target=https%3A//github.com/seata/seata/issues/1623" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">issue</a> 和 <a href="https://link.zhihu.com/?target=https%3A//github.com/seata/seata/pull/1629" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">PR</a>, 感兴趣的同学可以去看一下。</p><h3>subscribe</h3><div class="highlight"><pre><code class="language-java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="o">(</span><span class="n">String</span> <span class="n">cluster</span><span class="o">,</span> <span class="n">RedisListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 存储该 listener
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">redisRegistryKey</span> <span class="o">=</span> <span class="n">REDIS_FILEKEY_PREFIX</span> <span class="o">+</span> <span class="n">cluster</span><span class="o">;</span>
    <span class="n">LISTENER_SERVICE_MAP</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">cluster</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span>
    <span class="n">LISTENER_SERVICE_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cluster</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
    <span class="n">threadPoolExecutor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// 向 Redis 注册
</span><span class="c1"></span>                    <span class="n">jedis</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="k">new</span> <span class="n">NotifySub</span><span class="o">(</span><span class="n">LISTENER_SERVICE_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cluster</span><span class="o">)),</span> <span class="n">redisRegistryKey</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span></code></pre></div><p>流程如下: 1. 存储该 listener 2. 向 Redis 注册</p><p><code>RegistryService</code> 的主要功能就这些了,  TM 和 TC 是通过 lookup 找到服务器列表之后, 会根据设定的负载均衡策略请求 TC, 接下来我们看一看 loadbalance。</p><h3>loadbalance</h3><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LoadBalance</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Select t.
</span><span class="cm">     *
</span><span class="cm">     * @param &lt;T&gt;      the type parameter
</span><span class="cm">     * @param invokers the invokers
</span><span class="cm">     * @return the t
</span><span class="cm">     * @throws Exception the exception
</span><span class="cm">     */</span>
    <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">select</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">invokers</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p>这个接口的实现比较简单, 目前就只有随机和轮训。</p><h3>Config</h3><p>配置模块也是一个比较基础，比较简单的模块。我们需要配置一些常用的参数比如:Netty的select线程数量，work线程数量，session允许最大为多少等等，当然这些参数在 Seata 中都有自己的默认设置。</p><p>同样的在 Seata 中也提供了一个接口 Configuration，通过它来存取配置内容:</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Configuration</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// 这里只保留了 getShort 其他都类似
</span><span class="c1"></span>    <span class="cm">/**
</span><span class="cm">     * Gets short.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param defaultValue the default value
</span><span class="cm">     * @param timeoutMills the timeout mills
</span><span class="cm">     * @return the short
</span><span class="cm">     */</span>
    <span class="kt">short</span> <span class="nf">getShort</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defaultValue</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMills</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets short.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param defaultValue the default value
</span><span class="cm">     * @return the int
</span><span class="cm">     */</span>
    <span class="kt">short</span> <span class="nf">getShort</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="kt">short</span> <span class="n">defaultValue</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets short.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId the data id
</span><span class="cm">     * @return the int
</span><span class="cm">     */</span>
    <span class="kt">short</span> <span class="nf">getShort</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets config.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param defaultValue the default value
</span><span class="cm">     * @param timeoutMills the timeout mills
</span><span class="cm">     * @return the config
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">getConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">String</span> <span class="n">defaultValue</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMills</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets config.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param defaultValue the default value
</span><span class="cm">     * @return the config
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">getConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">String</span> <span class="n">defaultValue</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets config.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param timeoutMills the timeout mills
</span><span class="cm">     * @return the config
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">getConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMills</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets config.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId the data id
</span><span class="cm">     * @return the config
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">getConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Put config boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param content      the content
</span><span class="cm">     * @param timeoutMills the timeout mills
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">putConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMills</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Put config boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId  the data id
</span><span class="cm">     * @param content the content
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">putConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Put config if absent boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param content      the content
</span><span class="cm">     * @param timeoutMills the timeout mills
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">putConfigIfAbsent</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMills</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Put config if absent boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId  the data id
</span><span class="cm">     * @param content the content
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">putConfigIfAbsent</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Remove config boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId       the data id
</span><span class="cm">     * @param timeoutMills the timeout mills
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">removeConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeoutMills</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Remove config boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId the data id
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">removeConfig</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Add config listener.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId   the data id
</span><span class="cm">     * @param listener the listener
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">addConfigListener</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">T</span> <span class="n">listener</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Remove config listener.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId   the data id
</span><span class="cm">     * @param listener the listener
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">removeConfigListener</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">,</span> <span class="n">T</span> <span class="n">listener</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets config listeners.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId the data id
</span><span class="cm">     * @return the config listeners
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getConfigListeners</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Gets config from sys pro.
</span><span class="cm">     *
</span><span class="cm">     * @param dataId the data id
</span><span class="cm">     * @return the config from sys pro
</span><span class="cm">     */</span>
    <span class="k">default</span> <span class="n">String</span> <span class="nf">getConfigFromSysPro</span><span class="o">(</span><span class="n">String</span> <span class="n">dataId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">dataId</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></div><ul><li>getShort/getInt/Long/Boolean/Config()：通过dataId来获取对应的值。</li><li>putConfig：用于添加配置。</li><li>removeConfig：删除一个配置。</li><li>add/remove/get ConfigListener：添加/删除/获取 配置监听器，一般用来监听配置的变更。</li></ul><p>目
前为止有四种方式获取 Config：File(文件获取), Nacos, Apollo, ZK，etcd。在 Seata 中首先现在项目 
resources 下保存一个 registry.conf 文件，在该文件中配置具体使用 Config 接口哪个实现类。</p><div class="highlight"><pre><code class="language-text">// registry.conf 相关内容
config {
  # file、nacos 、apollo、zk、consul
  type = "file"

  file {
    name = "file.conf"
  }
}</code></pre></div><p>config 相关的内容我们就不多描述了, 就是简单地存取数据, 发生变化时通知各个节点进行改变。</p><h3>Store</h3><p>存储层的实现对于 Seata 是否高性能，是否可靠非常关键。</p><p>如果存储层没有实现好，那么如果发生宕机，在 TC 中正在进行分布式事务处理的数据将会被丢失，既然使用了分布式事务，那么其肯定不能容忍丢失。如果存储层实现好了，但是其性能有很大问题，RM 可能会发生频繁回滚那么其完全无法应对高并发的场景。</p><p>在
 Seata 中默认提供了文件方式的存储，下面我们定义我们存储的数据为 Session，而我们的TM创造的全局事务数据叫 
GlobalSession，RM 创造的分支事务叫 BranchSession，一个 GlobalSession 可以拥有多个 
BranchSession。我们的目的就是要将这么多 Session 存储下来。</p><p>Seata 中目前有 2 种实现方案, 一种是基于文件的, 一种是基于 DB 的, 我们接下来会分别介绍。</p><h3>File</h3><p>基于文件的实现是 <code>FileTransactionStoreManager</code>,
 它可以使用同步刷盘或异步刷盘的策略，每当有 Session 
的状态的更新时，它都会将变化的内容存储起来。为了防止存储文件的无限增殖，当达到一定条件时，它会另打开一个文件从头开始记录，并将之前的文件保存起
来。这里有一个非常巧妙的设计，就是该方案既能保证所有超时事务不丢，只有已完成的事务被清除，同时文件的大小也得到了控制。我们会结合代码来介绍 
Seata 是如何做到的。</p><div class="highlight"><pre><code class="language-java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">writeSession</span><span class="o">(</span><span class="n">LogOperation</span> <span class="n">logOperation</span><span class="o">,</span> <span class="n">SessionStorable</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 靠锁保证安全
</span><span class="c1"></span>    <span class="n">writeSessionLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">curFileTrxNum</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 实际的写数据过程，将编码后的比特数组写入 FileChannel
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">writeDataFile</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionWriteStore</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">logOperation</span><span class="o">).</span><span class="na">encode</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">lastModifiedTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">curFileTrxNum</span> <span class="o">=</span> <span class="n">FILE_TRX_NUM</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
        <span class="c1">// 如果当前事务存储文件已经累计记录一定数量的事务，并且该文件使用时间达标，则进行当前文件的保存和新文件的创建
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">curFileTrxNum</span> <span class="o">%</span> <span class="n">PER_FILE_BLOCK_SIZE</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
            <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">trxStartTimeMills</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">MAX_TRX_TIMEOUT_MILLS</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">saveHistory</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">exx</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"writeSession error,"</span> <span class="o">+</span> <span class="n">exx</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">writeSessionLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// 实际刷盘过程，根据配置，可以是同步也可以是异步
</span><span class="c1"></span>    <span class="n">flushDisk</span><span class="o">(</span><span class="n">curFileTrxNum</span><span class="o">,</span> <span class="n">currFileChannel</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p>上面的代码，就是存储 Session 的入口，其中 <code>logOperation</code> 可以是增加、删除、更新，<code>session</code> 可以是 GlobalSession，也可以是 BranchSession。其中就 3 个关键函数，<code>writeDataFile</code>，<code>saveHistory</code>，<code>flushDisk</code>，我们分别介绍一下它们。</p><div class="highlight"><pre><code class="language-java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">writeDataFile</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bs</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bs</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">bs</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">ByteBuffer</span> <span class="n">byteBuffer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// 有一个默认缓存，如果该缓存太小，则临时申请
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">bs</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">4</span> <span class="o">&gt;</span> <span class="n">MAX_WRITE_BUFFER_SIZE</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//allocateNew
</span><span class="c1"></span>        <span class="n">byteBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">bs</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">4</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">byteBuffer</span> <span class="o">=</span> <span class="n">writeBuffer</span><span class="o">;</span>
        <span class="c1">//recycle
</span><span class="c1"></span>        <span class="n">byteBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">byteBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">bs</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
    <span class="n">byteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">bs</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">writeDataFileByBuffer</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">writeDataFileByBuffer</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">byteBuffer</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">byteBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="o">;</span> <span class="n">retry</span><span class="o">++)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 循环写入
</span><span class="c1"></span>            <span class="k">while</span> <span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">currFileChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">exx</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"write data file error:"</span> <span class="o">+</span> <span class="n">exx</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"write dataFile failed,retry more than :"</span> <span class="o">+</span> <span class="n">MAX_WRITE_RETRY</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p><code>writeDataFile</code> 的实现很简单，就是同步写入 FileChannel。接下来看一下最妙的 <code>saveHistory</code>。</p><div class="highlight"><pre><code class="language-java"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">saveHistory</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">result</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 找到内存中保存的所有超时的事务，这些事务是需要回滚的，不能清除，但是其他完成的事务是可以清除的，这个保存过程实际上就是将超时事务追加到当前文件的结尾
</span><span class="c1"></span>        <span class="n">result</span> <span class="o">=</span> <span class="n">findTimeoutAndSave</span><span class="o">();</span>
        <span class="c1">// 然后异步关闭文件
</span><span class="c1"></span>        <span class="n">writeDataFileRunnable</span><span class="o">.</span><span class="na">putRequest</span><span class="o">(</span><span class="k">new</span> <span class="n">CloseFileRequest</span><span class="o">(</span><span class="n">currFileChannel</span><span class="o">,</span> <span class="n">currRaf</span><span class="o">));</span>
        <span class="c1">// 同时，给文件改名为historyFullFileName，替换掉旧的historyFullFile，同一时刻，Seata 只会有 2 个事务存储文件，一个是currentDataFile代表正在使用的文件，一个是historyFullFile，存储了过往的所有可能有用的 Session
</span><span class="c1"></span>        <span class="n">Files</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="n">currDataFile</span><span class="o">.</span><span class="na">toPath</span><span class="o">(),</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">hisFullFileName</span><span class="o">).</span><span class="na">toPath</span><span class="o">(),</span> <span class="n">StandardCopyOption</span><span class="o">.</span><span class="na">REPLACE_EXISTING</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">exx</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"save history data file error,"</span> <span class="o">+</span> <span class="n">exx</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">initFile</span><span class="o">(</span><span class="n">currFullFileName</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// 找到所有超时的 Session 存储起来
</span><span class="c1"></span><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">findTimeoutAndSave</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">GlobalSession</span><span class="o">&gt;</span> <span class="n">globalSessionsOverMaxTimeout</span> <span class="o">=</span>
        <span class="n">sessionManager</span><span class="o">.</span><span class="na">findGlobalSessions</span><span class="o">(</span><span class="k">new</span> <span class="n">SessionCondition</span><span class="o">(</span><span class="n">MAX_TRX_TIMEOUT_MILLS</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">globalSessionsOverMaxTimeout</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">listBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="kt">int</span> <span class="n">totalSize</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="c1">// 1. find all data and merge
</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">GlobalSession</span> <span class="n">globalSession</span> <span class="o">:</span> <span class="n">globalSessionsOverMaxTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">TransactionWriteStore</span> <span class="n">globalWriteStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionWriteStore</span><span class="o">(</span><span class="n">globalSession</span><span class="o">,</span> <span class="n">LogOperation</span><span class="o">.</span><span class="na">GLOBAL_ADD</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">globalWriteStore</span><span class="o">.</span><span class="na">encode</span><span class="o">();</span>
        <span class="n">listBytes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="n">totalSize</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">INT_BYTE_SIZE</span><span class="o">;</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">BranchSession</span><span class="o">&gt;</span> <span class="n">branchSessIonsOverMaXTimeout</span> <span class="o">=</span> <span class="n">globalSession</span><span class="o">.</span><span class="na">getSortedBranches</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">branchSessIonsOverMaXTimeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">BranchSession</span> <span class="n">branchSession</span> <span class="o">:</span> <span class="n">branchSessIonsOverMaXTimeout</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">TransactionWriteStore</span> <span class="n">branchWriteStore</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="n">TransactionWriteStore</span><span class="o">(</span><span class="n">branchSession</span><span class="o">,</span> <span class="n">LogOperation</span><span class="o">.</span><span class="na">BRANCH_ADD</span><span class="o">);</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">branchWriteStore</span><span class="o">.</span><span class="na">encode</span><span class="o">();</span>
                <span class="n">listBytes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
                <span class="n">totalSize</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">INT_BYTE_SIZE</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 2. batch write
</span><span class="c1"></span>    <span class="n">ByteBuffer</span> <span class="n">byteBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">totalSize</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">:</span> <span class="n">listBytes</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">byteBuffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="n">byteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">writeDataFileByBuffer</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">currFileChannel</span><span class="o">.</span><span class="na">force</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p>现在我们知道 Seata 
同时最多有2个存储文件，一个是 currentDataFile 一个是 historyFullFile，currentDataFile 
存储了最新的数据，而 historyFullFile 相较于 currentDataFile，还存储了之前过期的所有 
Session。任何时候，如果 TC 宕机，重启时只要先读取 historyFullFile，再读取 currentDataFile 
就能恢复所有数据。</p><p>替换 historyFullFile 时，因为会将所有超时的 Session 信息先写入 
currentDataFile，然后才会将 currentDataFile 改名为 historyFullFile 并替换掉之前的 
oldHistoryFullFile，这样所有过期 Session 就被延续下去了，实际上 Session 过期时间和新建 
currentDataFile 的时间是一致的，都是 30 分钟，这样再进行 historyFullFile 替换时，之前的 
oldHistoryFullFile 实际上只会存在超时 Session 和完成的 Session，所有超时 Session 已经被记录在新的 
historyFullFile 中了，而完成的 Session 会在替换时，随着 oldHistoryFullFile 
一起被删除。这就是为什么我觉得这个地方的设计十分巧妙。</p><p>最后刷盘的过程也很简单。根据配置，如果是同步刷盘会用 <code>Future#get</code> 阻塞等待，否则异步进行，<code>writeDataFileRunnable</code> 内部有一个阻塞队列，会有一个线程循环从中提取任务并执行，应该不难理解吧。</p><div class="highlight"><pre><code class="language-java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">flushDisk</span><span class="o">(</span><span class="kt">long</span> <span class="n">curFileNum</span><span class="o">,</span> <span class="n">FileChannel</span> <span class="n">currFileChannel</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">FLUSH_DISK_MODE</span> <span class="o">==</span> <span class="n">FlushDiskMode</span><span class="o">.</span><span class="na">SYNC_MODEL</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SyncFlushRequest</span> <span class="n">syncFlushRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SyncFlushRequest</span><span class="o">(</span><span class="n">curFileNum</span><span class="o">,</span> <span class="n">currFileChannel</span><span class="o">);</span>
        <span class="n">writeDataFileRunnable</span><span class="o">.</span><span class="na">putRequest</span><span class="o">(</span><span class="n">syncFlushRequest</span><span class="o">);</span>
        <span class="n">syncFlushRequest</span><span class="o">.</span><span class="na">waitForFlush</span><span class="o">(</span><span class="n">MAX_WAIT_FOR_FLUSH_TIME_MILLS</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">writeDataFileRunnable</span><span class="o">.</span><span class="na">putRequest</span><span class="o">(</span><span class="k">new</span> <span class="n">AsyncFlushRequest</span><span class="o">(</span><span class="n">curFileNum</span><span class="o">,</span> <span class="n">currFileChannel</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><h3>DB</h3><p>接下来，我们看一下基于 DB 的实现。</p><div class="highlight"><pre><code class="language-java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">writeSession</span><span class="o">(</span><span class="n">LogOperation</span> <span class="n">logOperation</span><span class="o">,</span> <span class="n">SessionStorable</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">LogOperation</span><span class="o">.</span><span class="na">GLOBAL_ADD</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">logOperation</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">logStore</span><span class="o">.</span><span class="na">insertGlobalTransactionDO</span><span class="o">(</span><span class="n">convertGlobalTransactionDO</span><span class="o">(</span><span class="n">session</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">LogOperation</span><span class="o">.</span><span class="na">GLOBAL_UPDATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">logOperation</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">logStore</span><span class="o">.</span><span class="na">updateGlobalTransactionDO</span><span class="o">(</span><span class="n">convertGlobalTransactionDO</span><span class="o">(</span><span class="n">session</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">LogOperation</span><span class="o">.</span><span class="na">GLOBAL_REMOVE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">logOperation</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">logStore</span><span class="o">.</span><span class="na">deleteGlobalTransactionDO</span><span class="o">(</span><span class="n">convertGlobalTransactionDO</span><span class="o">(</span><span class="n">session</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">LogOperation</span><span class="o">.</span><span class="na">BRANCH_ADD</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">logOperation</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">logStore</span><span class="o">.</span><span class="na">insertBranchTransactionDO</span><span class="o">(</span><span class="n">convertBranchTransactionDO</span><span class="o">(</span><span class="n">session</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">LogOperation</span><span class="o">.</span><span class="na">BRANCH_UPDATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">logOperation</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">logStore</span><span class="o">.</span><span class="na">updateBranchTransactionDO</span><span class="o">(</span><span class="n">convertBranchTransactionDO</span><span class="o">(</span><span class="n">session</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">LogOperation</span><span class="o">.</span><span class="na">BRANCH_REMOVE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">logOperation</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">logStore</span><span class="o">.</span><span class="na">deleteBranchTransactionDO</span><span class="o">(</span><span class="n">convertBranchTransactionDO</span><span class="o">(</span><span class="n">session</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">StoreException</span><span class="o">(</span><span class="s">"Unknown LogOperation:"</span> <span class="o">+</span> <span class="n">logOperation</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p>基于 DB 的实现相较于基于文件的实现就显得朴实无华，<code>logStore</code> 实际上就是一个 DAO 层的接口，对应了数据的 CRUD，在重启恢复时只不过是按照条件遍历 DB 中的所有数据，进行 Session 恢复。</p><h3>Lock</h3><p>大
家知道数据库实现隔离级别主要是通过锁来实现的，同样的在分布式事务框架 Seata 
中要实现隔离级别也需要通过锁。一般在数据库中数据库的隔离级别一共有四种:读未提交，读已提交，可重复读，串行化。在 Seata 
中可以保证写操作的互斥性，而读的隔离级别一般是读未提交，但是提供了达到读已提交隔离的手段。</p><p>Lock 模块也就是 Seata 实现隔离级别的核心模块。在 Lock 模块中提供了一个接口用于管理我们的锁:</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LockManager</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Acquire lock boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param branchSession the branch session
</span><span class="cm">     * @return the boolean
</span><span class="cm">     * @throws TransactionException the transaction exception
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">acquireLock</span><span class="o">(</span><span class="n">BranchSession</span> <span class="n">branchSession</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Un lock boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param branchSession the branch session
</span><span class="cm">     * @return the boolean
</span><span class="cm">     * @throws TransactionException the transaction exception
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">releaseLock</span><span class="o">(</span><span class="n">BranchSession</span> <span class="n">branchSession</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Un lock boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param globalSession the global session
</span><span class="cm">     * @return the boolean
</span><span class="cm">     * @throws TransactionException the transaction exception
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">releaseGlobalSessionLock</span><span class="o">(</span><span class="n">GlobalSession</span> <span class="n">globalSession</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Is lockable boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param xid        the xid
</span><span class="cm">     * @param resourceId the resource id
</span><span class="cm">     * @param lockKey    the lock key
</span><span class="cm">     * @return the boolean
</span><span class="cm">     * @throws TransactionException the transaction exception
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">isLockable</span><span class="o">(</span><span class="n">String</span> <span class="n">xid</span><span class="o">,</span> <span class="n">String</span> <span class="n">resourceId</span><span class="o">,</span> <span class="n">String</span> <span class="n">lockKey</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Clean all locks.
</span><span class="cm">     *
</span><span class="cm">     * @throws TransactionException the transaction exception
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">cleanAllLocks</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span>

<span class="o">}</span></code></pre></div><ul><li>acquireLock：用于对我们的 BranchSession 加锁，这里虽然是传的分支事务 Session，实际上是对分支事务操作的数据行加锁，成功返回 true。</li><li>isLockable：根据事务 ID，资源 ID，锁住的Key来查询是否已经加锁。</li><li>releaseLock: 释放分支事务的所有锁。</li><li>releaseGlobalSessionLock： 释放全局事务的所有分支事务的锁。</li><li>cleanAllLocks：清除所有的锁。</li></ul><p>在 Seata 中, LockManager 下层有使用的锁有两种实现, 一种是基于内存的锁(Session 存储模式为 File 时使用), 一种是基于 DB 的(Session 存储模式为 DB 时使用)，它们都实现了 <code>Locker</code> 接口:</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Locker</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Acquire lock boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param rowLock the row lock
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">acquireLock</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RowLock</span><span class="o">&gt;</span> <span class="n">rowLock</span><span class="o">)</span> <span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * Un lock boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param rowLock the row lock
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">releaseLock</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RowLock</span><span class="o">&gt;</span> <span class="n">rowLock</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Is lockable boolean.
</span><span class="cm">     *
</span><span class="cm">     * @param rowLock the row lock
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">isLockable</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RowLock</span><span class="o">&gt;</span> <span class="n">rowLock</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * Clean all locks boolean.
</span><span class="cm">     *
</span><span class="cm">     * @return the boolean
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">cleanAllLocks</span><span class="o">();</span>
<span class="o">}</span></code></pre></div><p>我们可以看到, 在 Locker 中将 branchSession 的概念剥离出去了, 只保留了 RowLock 的概念, 责任更加单一, 接下来我们分别看看它的实现类。</p><h3>MemoryLocker</h3><p>内存锁的实现全都存在一个锁 Map 中, 它是整个 Locker 的实现核心, 我们先来看一下它的结构:</p><div class="highlight"><pre><code class="language-java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span> <span class="cm">/* resourceId */</span><span class="o">,</span>
        <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span> <span class="cm">/* tableName */</span><span class="o">,</span>
            <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">Integer</span> <span class="cm">/* bucketId */</span><span class="o">,</span>
                <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span> <span class="cm">/* pk */</span><span class="o">,</span> <span class="n">Long</span><span class="cm">/* transactionId */</span><span class="o">&gt;&gt;&gt;&gt;</span>
        <span class="n">LOCK_MAP</span>
        <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span></code></pre></div><p>我
们可以看到, 通过这个 Map 将锁的粒度控制的很小, 最外层 Map 的 key 是 resourceId, 也就是对应了一个 RM, 
然后第二层 Map 的 key 是表名, 对应了 RM 上操作的一张表, 下一层 Map 的 key 是 BucketID, Seata 
根据表主键哈希值进行了分桶, 让冲突的概率降低, 默认有 128 个桶, 最后一层 Map 的 key 才是主键, Value 
是持有该主键锁的事务 ID。</p><p>明确了锁存储的数据结构后, 再分析加解锁过程就清晰多了:</p><div class="highlight"><pre><code class="language-java"><span class="c1">// MemoryLocker
</span><span class="c1"></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">acquireLock</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RowLock</span><span class="o">&gt;</span> <span class="n">rowLocks</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">rowLocks</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">//no lock
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">resourceId</span> <span class="o">=</span> <span class="n">branchSession</span><span class="o">.</span><span class="na">getResourceId</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">transactionId</span> <span class="o">=</span> <span class="n">branchSession</span><span class="o">.</span><span class="na">getTransactionId</span><span class="o">();</span>

    <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">bucketHolder</span> <span class="o">=</span> <span class="n">branchSession</span><span class="o">.</span><span class="na">getLockHolder</span><span class="o">();</span>
    <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;&gt;</span> <span class="n">dbLockMap</span> <span class="o">=</span> <span class="n">LOCK_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">resourceId</span><span class="o">);</span>
    <span class="c1">// 确认 RM 对应的 Map 是否已经构建
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">dbLockMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LOCK_MAP</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">resourceId</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;&gt;());</span>
        <span class="n">dbLockMap</span> <span class="o">=</span> <span class="n">LOCK_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">resourceId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">RowLock</span> <span class="n">lock</span> <span class="o">:</span> <span class="n">rowLocks</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">tableName</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getTableName</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">pk</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getPk</span><span class="o">();</span>
        <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;</span> <span class="n">tableLockMap</span> <span class="o">=</span> <span class="n">dbLockMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tableName</span><span class="o">);</span>
        <span class="c1">// 确认表对应的 Map 是否已经构建好
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">tableLockMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dbLockMap</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">tableName</span><span class="o">,</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;&gt;());</span>
            <span class="n">tableLockMap</span> <span class="o">=</span> <span class="n">dbLockMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">tableName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">bucketId</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">%</span> <span class="n">BUCKET_PER_TABLE</span><span class="o">;</span>
        <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">bucketLockMap</span> <span class="o">=</span> <span class="n">tableLockMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bucketId</span><span class="o">);</span>
        <span class="c1">// 确认 bucket map 是否已经构建好
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">bucketLockMap</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">tableLockMap</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">bucketId</span><span class="o">,</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;());</span>
            <span class="n">bucketLockMap</span> <span class="o">=</span> <span class="n">tableLockMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bucketId</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 实际加锁过程
</span><span class="c1"></span>        <span class="n">Long</span> <span class="n">previousLockTransactionId</span> <span class="o">=</span> <span class="n">bucketLockMap</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">pk</span><span class="o">,</span> <span class="n">transactionId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">previousLockTransactionId</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//No existing lock, and now locked by myself
</span><span class="c1"></span>            <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">keysInHolder</span> <span class="o">=</span> <span class="n">bucketHolder</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bucketLockMap</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">keysInHolder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">bucketHolder</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">bucketLockMap</span><span class="o">,</span> <span class="k">new</span> <span class="n">ConcurrentSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;());</span>
                <span class="n">keysInHolder</span> <span class="o">=</span> <span class="n">bucketHolder</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bucketLockMap</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">keysInHolder</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pk</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">previousLockTransactionId</span> <span class="o">==</span> <span class="n">transactionId</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Locked by me before
</span><span class="c1"></span>            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Global lock on ["</span> <span class="o">+</span> <span class="n">tableName</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">pk</span> <span class="o">+</span> <span class="s">"] is holding by "</span> <span class="o">+</span> <span class="n">previousLockTransactionId</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// Release all acquired locks.
</span><span class="c1"></span>                <span class="n">branchSession</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TransactionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">FrameworkException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p>我们可以看到, 加锁的过程无非就是确认各级 Map 
中是否有自己要的数据, 如果没有就用 putIfAbsent 添加进去, 最后到主键所在的 bucketMap 时, 才是真正加锁并确认的过程:
 1. 使用 putIfAbsent 将自己的 transactionId 填入 bucketLockMap 2. 如果 
previousLockTransactionId 为空, 说明自己获得了锁, 把自己获得的锁记录在 branchSession 中, 
方便释放时查找 3. 如果 previousLockTransactionId 和自己的 transactionId 相同, 
说明这个锁之前就被自己持有了, 直接返回即可 4. 否则, 发生了锁冲突, 释放自己之前获取到的所有锁</p><p>其实, 
这个实现中原来有一个死锁的 bug, 之前给 bucket Map 的加锁过程, 使用了 Synchronized block, 如果两个分支 
Session 要同时锁一个表的相同数据, 并且加锁的顺序不同(BS1: row1, row2, row3; BS2: row3, row2, 
row1), 就会发生死锁。</p><p>导致这个 bug 的原因是Synchronized block 的作用范围有误, 将解锁过程也包在了该代码块中。所以, 当时我就提了 <a href="https://link.zhihu.com/?target=https%3A//github.com/seata/seata/issues/1603" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">issue</a> 和 <a href="https://link.zhihu.com/?target=https%3A//github.com/seata/seata/pull/1605" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">pr</a>, 有兴趣的同学可以去看一看。</p><p>释放锁的过程就很简单了, 遍历 branchSession 中持有的所有锁, 并依次释放它们。</p><div class="highlight"><pre><code class="language-java"><span class="c1">// MemoryLocker
</span><span class="c1"></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">releaseLock</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RowLock</span><span class="o">&gt;</span> <span class="n">rowLock</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 取出所有持有的锁
</span><span class="c1"></span>    <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">lockHolder</span> <span class="o">=</span> <span class="n">branchSession</span><span class="o">.</span><span class="na">getLockHolder</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lockHolder</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">lockHolder</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">lockHolder</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
    <span class="c1">// 挨个释放锁
</span><span class="c1"></span>    <span class="k">while</span> <span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">bucket</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">keys</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// remove lock only if it locked by myself
</span><span class="c1"></span>            <span class="n">bucket</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">branchSession</span><span class="o">.</span><span class="na">getTransactionId</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">lockHolder</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span></code></pre></div><p>这里大家可能会有疑问, 存在内存中的锁, 如果发生了崩溃, 重启的时候锁不就没了么, 其实 Seata 在重启并恢复 Session 的同时, 也会按顺序恢复各个 Session 的锁, 下面只会展示核心代码。</p><div class="highlight"><pre><code class="language-java"><span class="cm">/**
</span><span class="cm"> * io.seata.server.session.SessionHolder#reload
</span><span class="cm"> */</span>
<span class="kd">protected</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">reload</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">GlobalSession</span><span class="o">&gt;</span> <span class="n">reloadedSessions</span> <span class="o">=</span> <span class="n">ROOT_SESSION_MANAGER</span><span class="o">.</span><span class="na">allSessions</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">reloadedSessions</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reloadedSessions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">reloadedSessions</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">globalSession</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">GlobalStatus</span> <span class="n">globalStatus</span> <span class="o">=</span> <span class="n">globalSession</span><span class="o">.</span><span class="na">getStatus</span><span class="o">();</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">globalStatus</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="n">UnKnown</span><span class="o">:</span>
                <span class="k">case</span> <span class="n">Committed</span><span class="o">:</span>
                <span class="k">case</span> <span class="n">CommitFailed</span><span class="o">:</span>
                <span class="k">case</span> <span class="n">Rollbacked</span><span class="o">:</span>
                <span class="k">case</span> <span class="n">RollbackFailed</span><span class="o">:</span>
                <span class="k">case</span> <span class="n">TimeoutRollbacked</span><span class="o">:</span>
                <span class="k">case</span> <span class="n">TimeoutRollbackFailed</span><span class="o">:</span>
                <span class="k">case</span> <span class="n">Finished</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">ShouldNeverHappenException</span><span class="o">(</span><span class="s">"Reloaded Session should NOT be "</span> <span class="o">+</span> <span class="n">globalStatus</span><span class="o">);</span>
                <span class="k">case</span> <span class="n">AsyncCommitting</span><span class="o">:</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="c1">// 恢复未完成的异步提交过程
</span><span class="c1"></span>                        <span class="n">globalSession</span><span class="o">.</span><span class="na">addSessionLifecycleListener</span><span class="o">(</span><span class="n">getAsyncCommittingSessionManager</span><span class="o">());</span>
                        <span class="n">getAsyncCommittingSessionManager</span><span class="o">().</span><span class="na">addGlobalSession</span><span class="o">(</span><span class="n">globalSession</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TransactionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="n">ShouldNeverHappenException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
                    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">BranchSession</span><span class="o">&gt;</span> <span class="n">branchSessions</span> <span class="o">=</span> <span class="n">globalSession</span><span class="o">.</span><span class="na">getSortedBranches</span><span class="o">();</span>
                    <span class="c1">// Lock, 重新加锁
</span><span class="c1"></span>                    <span class="n">branchSessions</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">branchSession</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">branchSession</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TransactionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="n">ShouldNeverHappenException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                    <span class="c1">// ...
</span><span class="c1"></span>                <span class="o">}</span>
            <span class="o">}</span>

        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><h3>DataBaseLocker</h3><p>和 SessionManager 的实现相同, DataBaseLocker 的加锁过程实际上就是一个对 DB 增删数据。因为这部分比较简单, 所以我们只展示加锁的最核心内容: </p><div class="highlight"><pre><code class="language-java"><span class="c1">// LockStoreDataBaseDAO
</span><span class="c1"></span><span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">doAcquireLock</span><span class="o">(</span><span class="n">Connection</span> <span class="n">conn</span><span class="o">,</span> <span class="n">LockDO</span> <span class="n">lockDO</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//insert
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">insertLockSQL</span> <span class="o">=</span> <span class="n">LockStoreSqls</span><span class="o">.</span><span class="na">getInsertLockSQL</span><span class="o">(</span><span class="n">lockTable</span><span class="o">,</span> <span class="n">dbType</span><span class="o">);</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">insertLockSQL</span><span class="o">);</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">lockDO</span><span class="o">.</span><span class="na">getXid</span><span class="o">());</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">lockDO</span><span class="o">.</span><span class="na">getTransactionId</span><span class="o">());</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="n">lockDO</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">());</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">4</span><span class="o">,</span> <span class="n">lockDO</span><span class="o">.</span><span class="na">getResourceId</span><span class="o">());</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">lockDO</span><span class="o">.</span><span class="na">getTableName</span><span class="o">());</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">6</span><span class="o">,</span> <span class="n">lockDO</span><span class="o">.</span><span class="na">getPk</span><span class="o">());</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">7</span><span class="o">,</span> <span class="n">lockDO</span><span class="o">.</span><span class="na">getRowKey</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">StoreException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ps</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">ps</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><h3>Rpc</h3><p>保证 Seata 高性能的关键之一也是使用了 Netty 作为 RPC 框架，采用默认配置的线程模型如下图所示： </p><figure data-size="normal"><noscript><img src="https://picb.zhimg.com/v2-5a4632215072bd0a14b40580ba00b05d_b.jpg" data-rawwidth="1262" data-rawheight="486" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb" width="1262" data-original="https://picb.zhimg.com/v2-5a4632215072bd0a14b40580ba00b05d_r.jpg"/></noscript><img src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-5a4632215072bd0a14b40580ba00b05d_720w.jpg" data-rawwidth="1262" data-rawheight="486" data-size="normal" data-caption="" class="origin_image zh-lightbox-thumb lazy" data-original="https://picb.zhimg.com/v2-5a4632215072bd0a14b40580ba00b05d_r.jpg" data-actualsrc="https://picb.zhimg.com/v2-5a4632215072bd0a14b40580ba00b05d_b.jpg" data-lazy-status="ok" width="1262"></figure><p>
 如果采用默认的基本配置, 那么会有一个 Acceptor 线程用于处理客户端的链接，会有 cpu*2 数量的 NIO-Thread，在这些 
NIO-Thread 线程中不会做业务太重的事情，只会做一些速度比较快的事情，比如编解码，心跳事件，和 TM 
注册。一些比较费时间的业务操作将会交给业务线程池，默认情况下业务线程池配置为最小线程为 100，最大为 500。</p><p>关于 Netty 的使用基础, 我们这里就不详细介绍了, 简单说就是对于每个连接都会绑定上数据的 handler, 它会按照责任链的原则, 顺着 handler 的绑定顺序, 处理数据, 这里简单看下它都绑定了什么 handler:</p><div class="highlight"><pre><code class="language-java"><span class="c1">// Rpc Server 和 Rpc Client
</span><span class="c1"></span><span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">()</span>
    <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">IdleStateHandler</span><span class="o">(</span><span class="n">nettyServerConfig</span><span class="o">.</span><span class="na">getChannelMaxReadIdleSeconds</span><span class="o">(),</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">))</span>
    <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ProtocolV1Decoder</span><span class="o">())</span>
    <span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ProtocolV1Encoder</span><span class="o">())</span>
    <span class="o">.</span><span class="na">addList</span><span class="o">(</span><span class="k">this</span><span class="o">);</span></code></pre></div><p>我们可以看到, 它们都绑定了心跳组件 IdleStateHandler, 然后是编解码器, 最后是 Server(TC) 和 Client(TM RM), 它们会拿到原始的请求和回应数据, 据此来进行业务交互。</p><p>前
面介绍 Discover 模块时, 我们知道 Server 是将自己注册到注册中心, 然后 Client 订阅更新, 并得到 Server 
的列表, 最后通过负载均衡选择一个 Server 进行连接。当连接建立成功后, Server 会保存所有的连接, 在需要进行分支回滚和提交时, 
从所有 RM 的连接记录中, 找到对应 RM 的所有连接, 它会首先寻找最原始的 RM 节点, 如果该节点宕机了, 它会找到该 RM 
的其他节点, 然后发送分支提交请求。</p><h3>HA-Cluster</h3><p>尚未实现</p><h3>Metrics</h3><p>统计接口目前的实现也很简单, 就是在内存中计数, 然后支持通过 HTTP 获取统计数据，这部分很简单我就不展示了。</p><h3>Coordinator Core</h3><p>在 TC 端, 大部分工作都是响应 TM 的请求, 然后发送提交回滚请求给 RM，下达提交或回滚命令, 这些部分我们会在后面的 AT 模式串讲 和 TCC 模式串讲中介绍, 本节主要看一下在 TC 模块中, 自主进行的一些工作。</p><p>当
 TC 启动时, 先恢复本机的 Session, 然后启动 RPC Server, 最后注册自己的地址到注册中心, 这些我们前面已经介绍过了, 
除此之外, TC 还会启动几个后台线程, 这些线程保证了 TC 的协调工作能够在发生错误时, 最终能顺利完成, 我们来看一下这部分的代码:</p><div class="highlight"><pre><code class="language-java"><span class="cm">/**
</span><span class="cm"> * Init.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">retryRollbacking</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">handleRetryRollbacking</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Exception retry rollbacking ... "</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="n">0</span><span class="o">,</span> <span class="n">ROLLBACKING_RETRY_PERIOD</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>

    <span class="n">retryCommitting</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">handleRetryCommitting</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Exception retry committing ... "</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="n">0</span><span class="o">,</span> <span class="n">COMMITTING_RETRY_PERIOD</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>

    <span class="n">asyncCommitting</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">handleAsyncCommitting</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Exception async committing ... "</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="n">0</span><span class="o">,</span> <span class="n">ASYN_COMMITTING_RETRY_PERIOD</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>

    <span class="n">timeoutCheck</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">timeoutCheck</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Exception timeout checking ... "</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="n">0</span><span class="o">,</span> <span class="n">TIMEOUT_RETRY_PERIOD</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>

    <span class="n">undoLogDelete</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">undoLogDelete</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Exception undoLog deleting ... "</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="n">UNDOLOG_DELAY_DELETE_PERIOD</span><span class="o">,</span> <span class="n">UNDOLOG_DELETE_PERIOD</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
<span class="o">}</span></code></pre></div><p>我们可以看到, 这些后台任务分别是回滚重试, 提交重试, 异步提交, 超时检测, 删除没用的 AT 模式 undo log。</p><h3>TM</h3><p>TM 和 TC 一样是一个共通的模块, 无论是 AT 模式还是 TCC 模式都需要使用 TM 模块。</p><p>首先 TM 在启动的时候会去连接 TC Server, 然后然后通过该 TM Client 与 TC 模块进行通讯。在 TM 模块中最核心的接口就是 <code>GlobalTransaction</code>, 里面包含了全局事务的创建, 提交, 回滚过程, 其实质就是向 TC 发送 RPC 请求。</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultGlobalTransaction</span> <span class="kd">implements</span> <span class="n">GlobalTransaction</span> <span class="o">{</span>
    <span class="c1">// 只保留核心内容...
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">begin</span><span class="o">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">role</span> <span class="o">!=</span> <span class="n">GlobalTransactionRole</span><span class="o">.</span><span class="na">Launcher</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">check</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Ignore Begin(): just involved in global transaction ["</span> <span class="o">+</span> <span class="n">xid</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">xid</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">getXID</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">xid</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">.</span><span class="na">begin</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">timeout</span><span class="o">);</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">GlobalStatus</span><span class="o">.</span><span class="na">Begin</span><span class="o">;</span>
        <span class="n">RootContext</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">xid</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Begin new global transaction ["</span> <span class="o">+</span> <span class="n">xid</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">GlobalTransactionRole</span><span class="o">.</span><span class="na">Participant</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Participant has no responsibility of committing
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Ignore Commit(): just involved in global transaction ["</span> <span class="o">+</span> <span class="n">xid</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">xid</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">xid</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">getXID</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">xid</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">getXID</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">RootContext</span><span class="o">.</span><span class="na">unbind</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"["</span> <span class="o">+</span> <span class="n">xid</span> <span class="o">+</span> <span class="s">"] commit status:"</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rollback</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">role</span> <span class="o">==</span> <span class="n">GlobalTransactionRole</span><span class="o">.</span><span class="na">Participant</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Participant has no responsibility of committing
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Ignore Rollback(): just involved in global transaction ["</span> <span class="o">+</span> <span class="n">xid</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">xid</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">xid</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">getXID</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">xid</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">getXID</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">RootContext</span><span class="o">.</span><span class="na">unbind</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"["</span> <span class="o">+</span> <span class="n">xid</span> <span class="o">+</span> <span class="s">"] rollback status:"</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>我们可以看到, 这个接口中实际上没做什么实际的事, 它调用 transactionManager 发送消息, 然后将涉及到的全局事务 XID 保存起来, 我们看看它把数据存在什么地方了:</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalContextCore</span> <span class="kd">implements</span> <span class="n">ContextCore</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
        <span class="o">}</span>

    <span class="o">};</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">put</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>看上去, 它是将 XID 存在了 ThreadLocal 中, 这样在整个 RPC 调用的上下文中都能获取到 XID。接下来, 我们看看下层的 transactionManager 都做了什么:</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultTransactionManager</span> <span class="kd">implements</span> <span class="n">TransactionManager</span> <span class="o">{</span>
    <span class="c1">// All PRCs here
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">begin</span><span class="o">(</span><span class="n">String</span> <span class="n">applicationId</span><span class="o">,</span> <span class="n">String</span> <span class="n">transactionServiceGroup</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
        <span class="n">GlobalBeginRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GlobalBeginRequest</span><span class="o">();</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setTransactionName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
        <span class="n">GlobalBeginResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">GlobalBeginResponse</span><span class="o">)</span><span class="n">syncCall</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getResultCode</span><span class="o">()</span> <span class="o">==</span> <span class="n">ResultCode</span><span class="o">.</span><span class="na">Failed</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">TransactionException</span><span class="o">(</span><span class="n">TransactionExceptionCode</span><span class="o">.</span><span class="na">BeginFailed</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getMsg</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">getXid</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">GlobalStatus</span> <span class="nf">commit</span><span class="o">(</span><span class="n">String</span> <span class="n">xid</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
        <span class="n">GlobalCommitRequest</span> <span class="n">globalCommit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GlobalCommitRequest</span><span class="o">();</span>
        <span class="n">globalCommit</span><span class="o">.</span><span class="na">setXid</span><span class="o">(</span><span class="n">xid</span><span class="o">);</span>
        <span class="n">GlobalCommitResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">GlobalCommitResponse</span><span class="o">)</span><span class="n">syncCall</span><span class="o">(</span><span class="n">globalCommit</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">getGlobalStatus</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">GlobalStatus</span> <span class="nf">rollback</span><span class="o">(</span><span class="n">String</span> <span class="n">xid</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span> <span class="o">{</span>
        <span class="n">GlobalRollbackRequest</span> <span class="n">globalRollback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GlobalRollbackRequest</span><span class="o">();</span>
        <span class="n">globalRollback</span><span class="o">.</span><span class="na">setXid</span><span class="o">(</span><span class="n">xid</span><span class="o">);</span>
        <span class="n">GlobalRollbackResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="n">GlobalRollbackResponse</span><span class="o">)</span><span class="n">syncCall</span><span class="o">(</span><span class="n">globalRollback</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">getGlobalStatus</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>可以看到, TransactionManager 
才是真正做实事的, 消息的发送工作都在这里完成。好了, 至此我们知道了哪个接口管理着全局事务的记录, 哪个接口真正进行 RPC 调用, 
那么谁才是这些接口的真正调用者呢? Seata 使用了模板方法模式来进行这部分工作:</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionalTemplate</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Execute object.
</span><span class="cm">     *
</span><span class="cm">     * @param business the business
</span><span class="cm">     * @return the object
</span><span class="cm">     * @throws TransactionalExecutor.ExecutionException the execution exception
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="n">TransactionalExecutor</span> <span class="n">business</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="c1">// 1. get or create a transaction
</span><span class="c1"></span>        <span class="n">GlobalTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">GlobalTransactionContext</span><span class="o">.</span><span class="na">getCurrentOrCreate</span><span class="o">();</span>

        <span class="c1">// 1.1 get transactionInfo
</span><span class="c1"></span>        <span class="n">TransactionInfo</span> <span class="n">txInfo</span> <span class="o">=</span> <span class="n">business</span><span class="o">.</span><span class="na">getTransactionInfo</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">txInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ShouldNeverHappenException</span><span class="o">(</span><span class="s">"transactionInfo does not exist"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>

            <span class="c1">// 2. begin transaction
</span><span class="c1"></span>            <span class="n">beginTransaction</span><span class="o">(</span><span class="n">txInfo</span><span class="o">,</span> <span class="n">tx</span><span class="o">);</span>

            <span class="n">Object</span> <span class="n">rs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>

                <span class="c1">// Do Your Business
</span><span class="c1"></span>                <span class="n">rs</span> <span class="o">=</span> <span class="n">business</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">// 3.the needed business exception to rollback.
</span><span class="c1"></span>                <span class="n">completeTransactionAfterThrowing</span><span class="o">(</span><span class="n">txInfo</span><span class="o">,</span><span class="n">tx</span><span class="o">,</span><span class="n">ex</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// 4. everything is fine, commit.
</span><span class="c1"></span>            <span class="n">commitTransaction</span><span class="o">(</span><span class="n">tx</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">rs</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">//5. clear
</span><span class="c1"></span>            <span class="n">triggerAfterCompletion</span><span class="o">();</span>
            <span class="n">cleanUp</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>该模板的工作流程如下: 1. 
看看当前是不是已经在一个分布式事务中了, 如果是, 则复用现存的全局事务, 否则创建新的     - 什么时候会出现已经存在全局事务的情况呢? 
假设 A 调用了 B, A 创建了全局事务 GT1, B 碰巧也执行了上述的模板, 这时候 B 就不会创建新的全局事务, 而是使用 GT1, 
这实际上是前面提到的事物的传播 2. 如果是自己创建的全局事务, 则发 RPC 开始事务, 如果不是自己创建的则什么都不干 3. 
执行真正的业务逻辑 4. 如果发生了异常, 如果自己创建全局事务, 才负责回滚, 否则就只管异常外抛 5. 如果没发生异常, 
如果自己创建全局事务, 才负责提交, 否则就什么都不做 6. 清理工作</p><p>我们看到, 该模板实际上是业务服务的完整执行流程, 
那我们每次都要自己在代码中通过该模板接口执行自己的业务代码吗? 当然不用, 实际上 Seata 基于 Spring 切面, 
已经帮我们做了这些事, 我们只需要使用 GlobalTransactional 注解就够了, 接下来我们看看这部分内容:</p><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlobalTransactionalInterceptor</span> <span class="kd">implements</span> <span class="n">MethodInterceptor</span> <span class="o">{</span>
    <span class="c1">// 只保留核心代码
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="kd">final</span> <span class="n">MethodInvocation</span> <span class="n">methodInvocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">methodInvocation</span><span class="o">.</span><span class="na">getThis</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">AopUtils</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">(</span><span class="n">methodInvocation</span><span class="o">.</span><span class="na">getThis</span><span class="o">())</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">Method</span> <span class="n">specificMethod</span> <span class="o">=</span> <span class="n">ClassUtils</span><span class="o">.</span><span class="na">getMostSpecificMethod</span><span class="o">(</span><span class="n">methodInvocation</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">targetClass</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">BridgeMethodResolver</span><span class="o">.</span><span class="na">findBridgedMethod</span><span class="o">(</span><span class="n">specificMethod</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">GlobalTransactional</span> <span class="n">globalTransactionalAnnotation</span> <span class="o">=</span> <span class="n">getAnnotation</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">GlobalTransactional</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">GlobalLock</span> <span class="n">globalLockAnnotation</span> <span class="o">=</span> <span class="n">getAnnotation</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">GlobalLock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">globalTransactionalAnnotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">handleGlobalTransaction</span><span class="o">(</span><span class="n">methodInvocation</span><span class="o">,</span> <span class="n">globalTransactionalAnnotation</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">globalLockAnnotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">handleGlobalLock</span><span class="o">(</span><span class="n">methodInvocation</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">methodInvocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Object</span> <span class="nf">handleGlobalLock</span><span class="o">(</span><span class="kd">final</span> <span class="n">MethodInvocation</span> <span class="n">methodInvocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">globalLockTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">methodInvocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">Exception</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="o">(</span><span class="n">Exception</span><span class="o">)</span><span class="n">e</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Object</span> <span class="nf">handleGlobalTransaction</span><span class="o">(</span><span class="kd">final</span> <span class="n">MethodInvocation</span> <span class="n">methodInvocation</span><span class="o">,</span>
                                           <span class="kd">final</span> <span class="n">GlobalTransactional</span> <span class="n">globalTrxAnno</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">transactionalTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionalExecutor</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">Object</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">methodInvocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="kd">public</span> <span class="n">String</span> <span class="nf">name</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">globalTrxAnno</span><span class="o">.</span><span class="na">name</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNullOrEmpty</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="n">formatMethod</span><span class="o">(</span><span class="n">methodInvocation</span><span class="o">.</span><span class="na">getMethod</span><span class="o">());</span>
                <span class="o">}</span>

                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">TransactionInfo</span> <span class="nf">getTransactionInfo</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">TransactionInfo</span> <span class="n">transactionInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionInfo</span><span class="o">();</span>
                    <span class="n">transactionInfo</span><span class="o">.</span><span class="na">setTimeOut</span><span class="o">(</span><span class="n">globalTrxAnno</span><span class="o">.</span><span class="na">timeoutMills</span><span class="o">());</span>
                    <span class="n">transactionInfo</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">());</span>
                    <span class="n">Set</span><span class="o">&lt;</span><span class="n">RollbackRule</span><span class="o">&gt;</span> <span class="n">rollbackRules</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rbRule</span> <span class="o">:</span> <span class="n">globalTrxAnno</span><span class="o">.</span><span class="na">rollbackFor</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">rollbackRules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">RollbackRule</span><span class="o">(</span><span class="n">rbRule</span><span class="o">));</span>
                    <span class="o">}</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">rbRule</span> <span class="o">:</span> <span class="n">globalTrxAnno</span><span class="o">.</span><span class="na">rollbackForClassName</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">rollbackRules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">RollbackRule</span><span class="o">(</span><span class="n">rbRule</span><span class="o">));</span>
                    <span class="o">}</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rbRule</span> <span class="o">:</span> <span class="n">globalTrxAnno</span><span class="o">.</span><span class="na">noRollbackFor</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">rollbackRules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">NoRollbackRule</span><span class="o">(</span><span class="n">rbRule</span><span class="o">));</span>
                    <span class="o">}</span>
                    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">rbRule</span> <span class="o">:</span> <span class="n">globalTrxAnno</span><span class="o">.</span><span class="na">noRollbackForClassName</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">rollbackRules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">NoRollbackRule</span><span class="o">(</span><span class="n">rbRule</span><span class="o">));</span>
                    <span class="o">}</span>
                    <span class="n">transactionInfo</span><span class="o">.</span><span class="na">setRollbackRules</span><span class="o">(</span><span class="n">rollbackRules</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">transactionInfo</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TransactionalExecutor</span><span class="o">.</span><span class="na">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">TransactionalExecutor</span><span class="o">.</span><span class="na">Code</span> <span class="n">code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">code</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">case</span> <span class="n">RollbackDone</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">getOriginalException</span><span class="o">();</span>
                <span class="k">case</span> <span class="n">BeginFailure</span><span class="o">:</span>
                    <span class="n">failureHandler</span><span class="o">.</span><span class="na">onBeginFailure</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
                    <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
                <span class="k">case</span> <span class="n">CommitFailure</span><span class="o">:</span>
                    <span class="n">failureHandler</span><span class="o">.</span><span class="na">onCommitFailure</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
                    <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
                <span class="k">case</span> <span class="n">RollbackFailure</span><span class="o">:</span>
                    <span class="n">failureHandler</span><span class="o">.</span><span class="na">onRollbackFailure</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(),</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">());</span>
                    <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">ShouldNeverHappenException</span><span class="o">(</span><span class="s">"Unknown TransactionalExecutor.Code: "</span> <span class="o">+</span> <span class="n">code</span><span class="o">);</span>

            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>我们可以看到, 上面的就是全局事务的拦截器, 它扫描 <code>GlobalTransactional</code> 和 <code>GlobalLock</code>, 如果是 <code>GlobalTransactional</code> 则用 transactionalTemplate 来执行真正的业务代码, 此外还从注解中拿出配置的回滚条件, 超时时间等配置, 给 transactionalTemplate 使用。</p><p>大
家也看到了这个拦截器中, 还有一个 globalLockTemplate, 实际上这个是在 RM 中使用的, 至于为什么, 
使用我们在前面的理论环节已经介绍了, 这里就不赘述了, 而且该模板代码也很简单, 就是加锁-&gt;执行-&gt;放锁, 
并且这里的加锁和放锁只是改变 Context 中的标志位, 真正通过 RPC 进行锁确认的过程, 我们后面会介绍。</p><p>至此, 
我们知道了 TM 是如何觉察到全局事务需求(GlobalTransactional 注解), 如何创建全局事务(RPC 调用 TC 接口), 
如何通过模板方法模式完成对业务的封装(GlobalTransactionTemplate)。那么还有一个问题, 事务信息是怎么传递的呢, TM 
怎么将全局事务 XID 传递给 RPC 的提供者的呢? 这部分, 根据 RPC 框架的不同, 需要不同的实现, 但是本质上都是一样的, 拦截 
RPC 的调用过程, 在 RPC 请求中加一个隐藏属性来存储 XID, RPC 的提供方从请求中获取到该隐藏属性, 然后存储在事务 
Context 的 ThreadLocal 中, 我们以 Dubbo 为例, 看一看它是怎么做的:</p><div class="highlight"><pre><code class="language-java"><span class="nd">@Activate</span><span class="o">(</span><span class="n">group</span> <span class="o">=</span> <span class="o">{</span><span class="n">Constants</span><span class="o">.</span><span class="na">PROVIDER</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">CONSUMER</span><span class="o">},</span> <span class="n">order</span> <span class="o">=</span> <span class="n">100</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionPropagationFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">TransactionPropagationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Invoker</span><span class="o">&lt;?&gt;</span> <span class="n">invoker</span><span class="o">,</span> <span class="n">Invocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RpcException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">xid</span> <span class="o">=</span> <span class="n">RootContext</span><span class="o">.</span><span class="na">getXID</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">rpcXid</span> <span class="o">=</span> <span class="n">RpcContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAttachment</span><span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">KEY_XID</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"xid in RootContext["</span> <span class="o">+</span> <span class="n">xid</span> <span class="o">+</span> <span class="s">"] xid in RpcContext["</span> <span class="o">+</span> <span class="n">rpcXid</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">boolean</span> <span class="n">bind</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">xid</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果当前存在 xid 说明是 RPC 发起方, 将 xid 存在 RPC context 中, 它会随着 RPC request 一起发送
</span><span class="c1"></span>            <span class="n">RpcContext</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAttachment</span><span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">KEY_XID</span><span class="o">,</span> <span class="n">xid</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 否则他就是 RPC 提供方, 它从 rpc context 中拿到 xid, 并设置到事务 context 中
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">rpcXid</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">RootContext</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">rpcXid</span><span class="o">);</span>
                <span class="n">bind</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"bind["</span> <span class="o">+</span> <span class="n">rpcXid</span> <span class="o">+</span> <span class="s">"] to RootContext"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">invoker</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// 最后清除事务 context 中绑定的 xid, 防止 ThreadLocal 内容污染下次调用
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">bind</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">unbindXid</span> <span class="o">=</span> <span class="n">RootContext</span><span class="o">.</span><span class="na">unbind</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">LOGGER</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"unbind["</span> <span class="o">+</span> <span class="n">unbindXid</span> <span class="o">+</span> <span class="s">"] from RootContext"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">rpcXid</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">unbindXid</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"xid in change during RPC from "</span> <span class="o">+</span> <span class="n">rpcXid</span> <span class="o">+</span> <span class="s">" to "</span> <span class="o">+</span> <span class="n">unbindXid</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">unbindXid</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">RootContext</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">unbindXid</span><span class="o">);</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"bind ["</span> <span class="o">+</span> <span class="n">unbindXid</span> <span class="o">+</span> <span class="s">"] back to RootContext"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>看过我之前发的 <a href="https://zhuanlan.zhihu.com/Dubbo" class="internal" data-za-detail-view-id="1043">Dubbo</a>
 文章的同学, 可能还记得 Dubbo 是通过一个 Filter 的概念来表示 AOP 特性的，Filter 的注入基于 Dubbo 的 
SPI, 而 Seata 这里所做的就是实现了一个 Dubbo Filter, 把事务 Context 和 RPCContext 
中的数据做一下绑定。其他 RPC 框架的支持方案基本类似, 这里就不再赘述了, 值得一提的是, 如果全局事务中的各个微服务是通过 HTTP 
请求来互相调用的话, 可以将 XID 存储在 HTTP Header 中, 在官方的提供的 Sample 中有一份样例代码:</p><div class="highlight"><pre><code class="language-java"><span class="c1">// 实现 servlet filter, 这样服务提供者能从 Http request 中获取 xid 并绑定进事务 Context
</span><span class="c1"></span><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeataFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="n">HttpServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">servletRequest</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">xid</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">KEY_XID</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">());</span>
        <span class="kt">boolean</span> <span class="n">isBind</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">xid</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">RootContext</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">xid</span><span class="o">);</span>
            <span class="n">isBind</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span> <span class="n">servletResponse</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isBind</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">RootContext</span><span class="o">.</span><span class="na">unbind</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// 实现 ClientHttpRequestInterceptor, 服务请求方讲 xid 塞入 http request header
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeataRestTemplateInterceptor</span> <span class="kd">implements</span> <span class="n">ClientHttpRequestInterceptor</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">ClientHttpResponse</span> <span class="nf">intercept</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">httpRequest</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">ClientHttpRequestExecution</span> <span class="n">clientHttpRequestExecution</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">HttpRequestWrapper</span> <span class="n">requestWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpRequestWrapper</span><span class="o">(</span><span class="n">httpRequest</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">xid</span> <span class="o">=</span> <span class="n">RootContext</span><span class="o">.</span><span class="na">getXID</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">xid</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">requestWrapper</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">RootContext</span><span class="o">.</span><span class="na">KEY_XID</span><span class="o">,</span> <span class="n">xid</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">clientHttpRequestExecution</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">requestWrapper</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// 找到所有 RestTemplate 将 SeataRestTemplateInterceptor 注入
</span><span class="c1"></span><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeataRestTemplateAutoConfiguration</span> <span class="o">{</span>
    <span class="nd">@Autowired</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">RestTemplate</span><span class="o">&gt;</span> <span class="n">restTemplates</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">SeataRestTemplateInterceptor</span> <span class="n">seataRestTemplateInterceptor</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">restTemplates</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Iterator</span> <span class="n">var1</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">restTemplates</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">var1</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">RestTemplate</span> <span class="n">restTemplate</span> <span class="o">=</span> <span class="o">(</span><span class="n">RestTemplate</span><span class="o">)</span> <span class="n">var1</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">ClientHttpRequestInterceptor</span><span class="o">&gt;</span> <span class="n">interceptors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">restTemplate</span><span class="o">.</span><span class="na">getInterceptors</span><span class="o">());</span>
                <span class="n">interceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">seataRestTemplateInterceptor</span><span class="o">);</span>
                <span class="n">restTemplate</span><span class="o">.</span><span class="na">setInterceptors</span><span class="o">(</span><span class="n">interceptors</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div><p>至此, TM 的重要功能就介绍完了, 值得注意的是事务的传播过程不仅仅是 TM -&gt; RM, RM -&gt; RM 也会进行。接下来, 我们看一看 Seata 两种分支事务类型 AT 和 TCC 的实现方案。</p><h2>参考内容</h2><p>[1] <a href="https://link.zhihu.com/?target=https%3A//www.jianshu.com/p/4cb127b737cf" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">https://www.</span><span class="visible">jianshu.com/p/4cb127b73</span><span class="invisible">7cf</span><span class="ellipsis"></span></a></p><p>[2] <a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/EzmZ-DAi-hxJhRkFvFhlJQ" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">mp.weixin.qq.com/s/EzmZ</span><span class="invisible">-DAi-hxJhRkFvFhlJQ</span><span class="ellipsis"></span></a></p><p>[3] <a href="https://link.zhihu.com/?target=https%3A//my.oschina.net/keking/blog/3011509" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">my.oschina.net/keking/b</span><span class="invisible">log/3011509</span><span class="ellipsis"></span></a></p><p>[4] <a href="https://zhuanlan.zhihu.com/p/64484721" class="internal" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">zhuanlan.zhihu.com/p/64</span><span class="invisible">484721</span><span class="ellipsis"></span></a></p><p>[5] <a href="https://zhuanlan.zhihu.com/p/61981170" class="internal" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">zhuanlan.zhihu.com/p/61</span><span class="invisible">981170</span><span class="ellipsis"></span></a></p><p>[6] <a href="https://zhuanlan.zhihu.com/p/78269431" class="internal" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">zhuanlan.zhihu.com/p/78</span><span class="invisible">269431</span><span class="ellipsis"></span></a></p><p>[7] <a href="https://zhuanlan.zhihu.com/p/72060852" class="internal" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">zhuanlan.zhihu.com/p/72</span><span class="invisible">060852</span><span class="ellipsis"></span></a></p><p>[8] <a href="https://zhuanlan.zhihu.com/p/63552935" class="internal" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">zhuanlan.zhihu.com/p/63</span><span class="invisible">552935</span><span class="ellipsis"></span></a></p><p>[9] <a href="https://link.zhihu.com/?target=https%3A//www.bookstack.cn/read/fescar-0.4.0/spilt.1.0.md" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">https://www.</span><span class="visible">bookstack.cn/read/fesca</span><span class="invisible">r-0.4.0/spilt.1.0.md</span><span class="ellipsis"></span></a></p><p>[10] <a href="https://link.zhihu.com/?target=https%3A//github.com/seata/seata/wiki" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">github.com/seata/seata/</span><span class="invisible">wiki</span><span class="ellipsis"></span></a></p><p>[11] <a href="https://link.zhihu.com/?target=https%3A//juejin.im/post/5caabe29e51d452b1e719265" class=" external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043"><span class="invisible">https://</span><span class="visible">juejin.im/post/5caabe29</span><span class="invisible">e51d452b1e719265</span><span class="ellipsis"></span></a></p><p class="ztext-empty-paragraph"><br></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-d592b179309467a882e9cbe9a3ce0fcc_b.jpg" data-rawwidth="600" data-rawheight="600" data-size="normal" class="origin_image zh-lightbox-thumb" width="600" data-original="https://pic4.zhimg.com/v2-d592b179309467a882e9cbe9a3ce0fcc_r.jpg"/></noscript><img src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-d592b179309467a882e9cbe9a3ce0fcc_720w.jpg" data-rawwidth="600" data-rawheight="600" data-size="normal" class="origin_image zh-lightbox-thumb lazy" data-original="https://pic4.zhimg.com/v2-d592b179309467a882e9cbe9a3ce0fcc_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-d592b179309467a882e9cbe9a3ce0fcc_b.jpg" data-lazy-status="ok" width="600"></figure><p></p></div></div><div class="ContentItem-time">编辑于 2019-10-17</div><div class="Post-topicsAndReviewer"><div class="TopicList Post-Topics"><div class="Tag Topic" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19802604&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="https://www.zhihu.com/topic/19802604" target="_blank"><div class="Popover"><div id="Popover1-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover1-content">分布式事务</div></div></a></span></div><div class="Tag Topic" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19561132&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="https://www.zhihu.com/topic/19561132" target="_blank"><div class="Popover"><div id="Popover2-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover2-content">Java</div></div></a></span></div><div class="Tag Topic" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19593602&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="https://www.zhihu.com/topic/19593602" target="_blank"><div class="Popover"><div id="Popover3-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover3-content">源码阅读</div></div></a></span></div></div></div><div><div class="Sticky RichContent-actions is-fixed is-bottom" style="width: 690px; bottom: 0px; left: 249px;"><div class="ContentItem-actions" data-za-detail-view-path-module="BottomBar" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;id&quot;:&quot;87100741&quot;}}}"><span><button aria-label="赞同 3 " type="button" class="Button VoteButton VoteButton--up"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--TriangleUp VoteButton-TriangleUp" fill="currentColor" viewBox="0 0 24 24" width="10" height="10"><path d="M2 18.242c0-.326.088-.532.237-.896l7.98-13.203C10.572 3.57 11.086 3 12 3c.915 0 1.429.571 1.784 1.143l7.98 13.203c.15.364.236.57.236.896 0 1.386-.875 1.9-1.955 1.9H3.955c-1.08 0-1.955-.517-1.955-1.9z" fill-rule="evenodd"></path></svg></span>赞同 3</button><button aria-label="反对" type="button" class="Button VoteButton VoteButton--down"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--TriangleDown" fill="currentColor" viewBox="0 0 24 24" width="10" height="10"><path d="M20.044 3H3.956C2.876 3 2 3.517 2 4.9c0 .326.087.533.236.896L10.216 19c.355.571.87 1.143 1.784 1.143s1.429-.572 1.784-1.143l7.98-13.204c.149-.363.236-.57.236-.896 0-1.386-.876-1.9-1.956-1.9z" fill-rule="evenodd"></path></svg></span></button></span><button type="button" class="Button BottomActions-CommentBtn Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Comment Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M10.241 19.313a.97.97 0 0 0-.77.2 7.908 7.908 0 0 1-3.772 1.482.409.409 0 0 1-.38-.637 5.825 5.825 0 0 0 1.11-2.237.605.605 0 0 0-.227-.59A7.935 7.935 0 0 1 3 11.25C3 6.7 7.03 3 12 3s9 3.7 9 8.25-4.373 9.108-10.759 8.063z" fill-rule="evenodd"></path></svg></span>1 条评论</button><div class="Popover ShareMenu"><div class="ShareMenu-toggler" id="Popover4-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover4-content"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Share Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M2.931 7.89c-1.067.24-1.275 1.669-.318 2.207l5.277 2.908 8.168-4.776c.25-.127.477.198.273.39L9.05 14.66l.927 5.953c.18 1.084 1.593 1.376 2.182.456l9.644-15.242c.584-.892-.212-2.029-1.234-1.796L2.93 7.89z" fill-rule="evenodd"></path></svg></span>分享</button></div></div><button type="button" class="Button ContentItem-action Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Heart Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M2 8.437C2 5.505 4.294 3.094 7.207 3 9.243 3 11.092 4.19 12 6c.823-1.758 2.649-3 4.651-3C19.545 3 22 5.507 22 8.432 22 16.24 13.842 21 12 21 10.158 21 2 16.24 2 8.437z" fill-rule="evenodd"></path></svg></span>喜欢</button><button type="button" class="Button ContentItem-action Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Star Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M5.515 19.64l.918-5.355-3.89-3.792c-.926-.902-.639-1.784.64-1.97L8.56 7.74l2.404-4.871c.572-1.16 1.5-1.16 2.072 0L15.44 7.74l5.377.782c1.28.186 1.566 1.068.64 1.97l-3.89 3.793.918 5.354c.219 1.274-.532 1.82-1.676 1.218L12 18.33l-4.808 2.528c-1.145.602-1.896.056-1.677-1.218z" fill-rule="evenodd"></path></svg></span>收藏</button><div class="Post-ActionMenuButton"><div class="Popover"><div id="Popover5-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover5-content"><button type="button" class="Button Button--plain Button--withIcon Button--iconOnly"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Dots Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M5 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm7 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm7 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4z" fill-rule="evenodd"></path></svg></span></button></div></div></div></div><div style="opacity: 1;" class="Post-SideActions"><button class="like"><div class="Post-SideActions-icon"><svg class="Zi Zi--TriangleUp Post-SideActions-upIcon" fill="currentColor" viewBox="0 0 24 24" width="16" height="16"><path d="M2 18.242c0-.326.088-.532.237-.896l7.98-13.203C10.572 3.57 11.086 3 12 3c.915 0 1.429.571 1.784 1.143l7.98 13.203c.15.364.236.57.236.896 0 1.386-.875 1.9-1.955 1.9H3.955c-1.08 0-1.955-.517-1.955-1.9z" fill-rule="evenodd"></path></svg></div><div class="likeCount"><div class="likeCount-inner" data-previous="已赞同 4">赞同 3</div></div></button><div class="Popover ShareMenu"><div class="ShareMenu-toggler" id="Popover16-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover16-content"><button><div class="Post-SideActions-icon"><span style="display: inline-flex; align-items: center;">​<svg class="Zi Zi--Share" fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M2.931 7.89c-1.067.24-1.275 1.669-.318 2.207l5.277 2.908 8.168-4.776c.25-.127.477.198.273.39L9.05 14.66l.927 5.953c.18 1.084 1.593 1.376 2.182.456l9.644-15.242c.584-.892-.212-2.029-1.234-1.796L2.93 7.89z" fill-rule="evenodd"></path></svg></span></div>分享</button></div></div></div></div><div class="Sticky--holder" style="position: static; inset: auto auto 0px 0px; display: block; float: none; margin: 0px 0px 10px; height: 54px;"></div></div></article><div class="Post-Sub Post-NormalSub"><div class="PostIndex-Contributions" data-za-detail-view-path-module="ColumnList" data-za-detail-view-path-module_name="文章被以下专栏收录" data-za-extra-module="{}"><h3 class="BlockTitle">文章被以下专栏收录</h3><ul><div class="ContentItem Column-ColumnItem"><div class="ContentItem-main"><div class="ContentItem-image"><a class="ColumnLink" href="https://www.zhihu.com/column/c_1167429588711337985"><div class="Popover"><div id="Popover6-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover6-content"><img class="Avatar Avatar--medium Avatar--round" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-6c1cd6e6e692b24a81be41c60786bd24_xs.jpg" srcset="https://pic1.zhimg.com/v2-6c1cd6e6e692b24a81be41c60786bd24_l.jpg?source=172ae18b 2x" alt="贝贝猫技术分享" width="40" height="40"></div></div></a></div><div class="ContentItem-head"><h2 class="ContentItem-title"><a class="ColumnLink ColumnItem-Title" href="https://www.zhihu.com/column/c_1167429588711337985"><div class="Popover"><div id="Popover7-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover7-content">贝贝猫技术分享</div></div></a></h2><div class="ContentItem-meta">专注于分享技术经验 公众号:bbm_share</div></div><div class="ContentItem-extra"><a href="https://www.zhihu.com/column/c_1167429588711337985" type="button" class="Button">进入专栏</a></div></div></div></ul></div><div class="Recommendations-Main" style="width: 1188px;"><h3 class="BlockTitle Recommendations-BlockTitle">推荐阅读</h3><ul class="Recommendations-List"><button class="PagingButton PagingButton-Previous" disabled="disabled" data-za-detail-view-path-module="Unknown" data-za-detail-view-path-module_name="推荐阅读" data-za-extra-module="{}"><svg class="Zi Zi--ArrowLeft" fill="#d3d3d3" viewBox="0 0 24 24" width="40" height="40"><path d="M14.782 16.78a.737.737 0 0 1-1.052 0L9.218 12.53a.758.758 0 0 1 0-1.063L13.73 7.22a.737.737 0 0 1 1.052 0c.29.294.29.77.001 1.063L11 12l3.782 3.716c.29.294.29.77 0 1.063z" fill-rule="evenodd"></path></svg></button><a href="https://zhuanlan.zhihu.com/p/221864999" class="PostItem"><div><img src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-6065b8e04748c58dc585e571d6d49d54_250x0.jpg" srcset="https://pic1.zhimg.com/v2-6065b8e04748c58dc585e571d6d49d54_qhd.jpg?source=172ae18b 2x" class="PostItem-TitleImage" alt="辣鸡，你怎么天天就会 try...catch ？试试这个"><h1 class="PostItem-Title">辣鸡，你怎么天天就会 try...catch ？试试这个</h1><div class="PostItem-Footer"><span>动力节点</span><span class="PostItem-FooterTitle">发表于动力节点技...</span></div></div></a><a href="https://zhuanlan.zhihu.com/p/57703136" class="PostItem"><div><h1 class="PostItem-Title">RocketMQ源码分析之服务发现</h1><p class="PostItem-Summary">一：前言何为服务发现？简单点说，就是通过一个名字，能够找到服务的通信地址。举个例子，我们平时打开浏览器进行上网，输入网址，浏览器向DNS服务器发起请求进行DNS解析，DNS服务器返回网…</p><div class="PostItem-Footer"><span>汪先生</span><span class="PostItem-FooterTitle"></span></div></div></a><a href="https://zhuanlan.zhihu.com/p/148342738" class="PostItem"><div><img src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-9e5f1d3df1a6e6ff842fe5d2d24b7cf5_250x0.jpg" srcset="https://pic3.zhimg.com/v2-9e5f1d3df1a6e6ff842fe5d2d24b7cf5_qhd.jpg?source=172ae18b 2x" class="PostItem-TitleImage" alt="老大吩咐的可重入分布式锁，终于完美的实现了~"><h1 class="PostItem-Title">老大吩咐的可重入分布式锁，终于完美的实现了~</h1><div class="PostItem-Footer"><span>楼下小黑哥</span><span class="PostItem-FooterTitle">发表于程序通事</span></div></div></a><a href="https://zhuanlan.zhihu.com/p/28376627" class="PostItem"><div><h1 class="PostItem-Title">深入理解Zuul之源码解析</h1><p class="PostItem-Summary">Zuul架构图在zuul中， 整个请求的过程是这样的，首先将请求给zuulservlet处理，zuulservlet中有一个zuulRunner对象，该对象中初始化了RequestContext：作为存储整个请求的一些数据，并被所…</p><div class="PostItem-Footer"><span>方志朋</span><span class="PostItem-FooterTitle">发表于极乐科技</span></div></div></a><button class="PagingButton PagingButton-Next" data-za-detail-view-path-module="Unknown" data-za-detail-view-path-module_name="推荐阅读" data-za-extra-module="{}"><svg class="Zi Zi--ArrowRight" fill="#d3d3d3" viewBox="0 0 24 24" width="40" height="40"><path d="M9.218 16.78a.737.737 0 0 0 1.052 0l4.512-4.249a.758.758 0 0 0 0-1.063L10.27 7.22a.737.737 0 0 0-1.052 0 .759.759 0 0 0-.001 1.063L13 12l-3.782 3.716a.758.758 0 0 0 0 1.063z" fill-rule="evenodd"></path></svg></button></ul></div><div class="Comments-container" data-za-detail-view-path-module="CommentList" data-za-extra-module="{}"><div class="CommentsV2 CommentsV2--withEditor CommentsV2-withPagination"><div class="Topbar CommentTopbar"><div class="Topbar-title"><h2 class="CommentTopbar-title">1 条评论</h2></div><div class="Topbar-options"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel"><span style="display: inline-flex; align-items: center;">​<svg class="Zi Zi--Switch Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M13.004 7V4.232c0-.405.35-.733.781-.733.183 0 .36.06.501.17l6.437 5.033c.331.26.376.722.1 1.033a.803.803 0 0 1-.601.264H2.75a.75.75 0 0 1-.75-.75V7.75A.75.75 0 0 1 2.75 7h10.254zm-1.997 9.999v2.768c0 .405-.35.733-.782.733a.814.814 0 0 1-.5-.17l-6.437-5.034a.702.702 0 0 1-.1-1.032.803.803 0 0 1 .6-.264H21.25a.75.75 0 0 1 .75.75v1.499a.75.75 0 0 1-.75.75H11.007z" fill-rule="evenodd"></path></svg></span>切换为时间排序</button></div></div><div><div class="CommentsV2-footer CommentEditorV2--normal"><div class="CommentEditorV2-inputWrap"><div class="InputLike CommentEditorV2-input Editable"><div style="min-height: 198px;" class="Dropzone Editable-content RichText RichText--editable RichText--clearBoth ztext"><div class="DraftEditor-root"><div class="public-DraftEditorPlaceholder-root"><div class="public-DraftEditorPlaceholder-inner" id="placeholder-3kovs" style="white-space: pre-wrap;">写下你的评论...</div></div><div class="DraftEditor-editorContainer"><div aria-describedby="placeholder-3kovs" class="notranslate public-DraftEditor-content" role="textbox" spellcheck="true" style="outline: currentcolor none medium; user-select: text; white-space: pre-wrap; overflow-wrap: break-word;" tabindex="0" contenteditable="true"><div data-contents="true"><div class="Editable-unstyled" data-block="true" data-editor="3kovs" data-offset-key="d0ofu-0-0"><div data-offset-key="d0ofu-0-0" class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr"><span data-offset-key="d0ofu-0-0"><br data-text="true"></span></div></div></div></div></div></div></div><input multiple="" type="file" style="display: none;" accept="image/jpg,image/jpeg,image/png,image/gif"><div></div></div><div class="CommentEditorV2-inputUpload"><div class="CommentEditorV2-popoverWrap"><div class="Popover CommentEditorV2-inputUpLoad-Icon"><button aria-label="插入表情" data-tooltip="插入表情" data-tooltip-position="bottom" data-tooltip-will-hide-on-click="true" id="Popover10-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover10-content" type="button" class="Button Editable-control Button--plain"><svg class="Zi Zi--Emotion" fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M7.523 13.5h8.954c-.228 2.47-2.145 4-4.477 4-2.332 0-4.25-1.53-4.477-4zM12 21a9 9 0 1 1 0-18 9 9 0 0 1 0 18zm0-1.5a7.5 7.5 0 1 0 0-15 7.5 7.5 0 0 0 0 15zm-3-8a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm6 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"></path></svg></button></div></div></div></div><button type="button" disabled="disabled" class="Button CommentEditorV2-singleButton Button--primary Button--blue">发布</button></div></div><div><div class="CommentListV2"><ul class="NestComment"><li class="NestComment--rootCommentNoChild"><div class="CommentItemV2"><div><div class="CommentItemV2-meta"><span class="UserLink CommentItemV2-avatar"><div class="Popover"><div id="Popover13-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover13-content"><a class="UserLink-link" data-za-detail-view-element_name="User" target="_blank" href="https://www.zhihu.com/people/wo-shi-a-li-shu-shu"><img class="Avatar UserLink-avatar" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/v2-61e5d4061c57ff774e65c528566489b8_s.jpg" srcset="https://pic2.zhimg.com/v2-61e5d4061c57ff774e65c528566489b8_xs.jpg 2x" alt="汀羽v587" width="24" height="24"></a></div></div></span><span class="UserLink"><a class="UserLink-link" data-za-detail-view-element_name="User" target="_blank" href="https://www.zhihu.com/people/wo-shi-a-li-shu-shu">汀羽v587</a></span><span class="CommentItemV2-time">2019-12-27</span></div><div class="CommentItemV2-metaSibling"><div class="CommentRichText CommentItemV2-content"><div class="RichText ztext"><p>看了关于死锁的issue和pr，厉害</p></div></div><div class="CommentItemV2-footer"><button type="button" class="Button CommentItemV2-likeBtn Button--plain"><span style="display: inline-flex; align-items: center;">​<svg class="Zi Zi--Like" style="margin-right: 5px;" fill="currentColor" viewBox="0 0 24 24" width="16" height="16"><path d="M14.445 9h5.387s2.997.154 1.95 3.669c-.168.51-2.346 6.911-2.346 6.911s-.763 1.416-2.86 1.416H8.989c-1.498 0-2.005-.896-1.989-2v-7.998c0-.987.336-2.032 1.114-2.639 4.45-3.773 3.436-4.597 4.45-5.83.985-1.13 3.2-.5 3.037 2.362C15.201 7.397 14.445 9 14.445 9zM3 9h2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V10a1 1 0 0 1 1-1z" fill-rule="evenodd"></path></svg></span>赞</button><button type="button" class="Button CommentItemV2-hoverBtn Button--plain"><span style="display: inline-flex; align-items: center;">​<svg class="Zi Zi--Reply" style="margin-right: 5px;" fill="currentColor" viewBox="0 0 24 24" width="16" height="16"><path d="M22.959 17.22c-1.686-3.552-5.128-8.062-11.636-8.65-.539-.053-1.376-.436-1.376-1.561V4.678c0-.521-.635-.915-1.116-.521L1.469 10.67a1.506 1.506 0 0 0-.1 2.08s6.99 6.818 7.443 7.114c.453.295 1.136.124 1.135-.501V17a1.525 1.525 0 0 1 1.532-1.466c1.186-.139 7.597-.077 10.33 2.396 0 0 .396.257.536.257.892 0 .614-.967.614-.967z" fill-rule="evenodd"></path></svg></span>回复</button><button type="button" class="Button CommentItemV2-hoverBtn Button--plain"><span style="display: inline-flex; align-items: center;">​<svg class="Zi Zi--Like" style="transform: rotate(180deg); margin-right: 5px;" fill="currentColor" viewBox="0 0 24 24" width="16" height="16"><path d="M14.445 9h5.387s2.997.154 1.95 3.669c-.168.51-2.346 6.911-2.346 6.911s-.763 1.416-2.86 1.416H8.989c-1.498 0-2.005-.896-1.989-2v-7.998c0-.987.336-2.032 1.114-2.639 4.45-3.773 3.436-4.597 4.45-5.83.985-1.13 3.2-.5 3.037 2.362C15.201 7.397 14.445 9 14.445 9zM3 9h2a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V10a1 1 0 0 1 1-1z" fill-rule="evenodd"></path></svg></span>踩</button><button type="button" class="Button CommentItemV2-hoverBtn Button--plain"><span style="display: inline-flex; align-items: center;">​<svg class="Zi Zi--Report" style="margin-right: 5px;" fill="currentColor" viewBox="0 0 24 24" width="16" height="16"><path d="M19.947 3.129c-.633.136-3.927.639-5.697.385-3.133-.45-4.776-2.54-9.949-.888-.997.413-1.277 1.038-1.277 2.019L3 20.808c0 .3.101.54.304.718a.97.97 0 0 0 .73.304c.275 0 .519-.102.73-.304.202-.179.304-.418.304-.718v-6.58c4.533-1.235 8.047.668 8.562.864 2.343.893 5.542.008 6.774-.657.397-.178.596-.474.596-.887V3.964c0-.599-.42-.972-1.053-.835z" fill-rule="evenodd"></path></svg></span>举报</button></div></div></div></div></li></ul></div></div></div></div></div></div></main><div class="CornerButtons"><div class="CornerAnimayedFlex"><button data-tooltip="回到顶部" data-tooltip-position="left" data-tooltip-will-hide-on-click="true" aria-label="回到顶部" type="button" class="Button CornerButton Button--plain"><svg class="Zi Zi--BackToTop" aria-label="回到顶部" fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M16.036 19.59a1 1 0 0 1-.997.995H9.032a.996.996 0 0 1-.997-.996v-7.005H5.03c-1.1 0-1.36-.633-.578-1.416L11.33 4.29a1.003 1.003 0 0 1 1.412 0l6.878 6.88c.782.78.523 1.415-.58 1.415h-3.004v7.005z"></path></svg></button></div></div></div></div><script nonce="" async="" src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/js"></script><script nonce="">function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-149949619-1");</script><script id="js-clientConfig" type="text/json">{"host":"zhihu.com","protocol":"https:","wwwHost":"www.zhihu.com","fetchRoot":{"www":"https:\u002F\u002Fwww.zhihu.com","api":"https:\u002F\u002Fapi.zhihu.com","zhuanlan":"https:\u002F\u002Fzhuanlan.zhihu.com"}}</script><script id="js-initialData" type="text/json">{"initialState":{"common":{"ask":{}},"loading":{"global":{"count":0},"local":{"env\u002FgetIpinfo\u002F":false,"article\u002Fget\u002F":false,"brand\u002FgetUrl\u002F":false}},"club":{"tags":{},"admins":{"data":[]},"members":{"data":[]},"explore":{"candidateSyncClubs":{}},"profile":{},"checkin":{},"comments":{"paging":{},"loading":{},"meta":{},"ids":{}},"postList":{"paging":{},"loading":{},"ids":{}},"recommend":{"data":[]},"silences":{"data":[]},"application":{"profile":null}},"entities":{"users":{"beikejiedeliulangmao":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpicb.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da.jpg?source=172ae18b","uid":"572701747039047680","userType":"people","isFollowing":false,"urlToken":"beikejiedeliulangmao","id":"7f1731e0c12e7c7a6fa8050e2b727c23","description":"昵称：贝克街的流浪猫（贝贝猫）\n微信公众号：bbm_share\n博客：https:\u002F\u002Fwww.beikejiedeliulangmao.top\nGithub: https:\u002F\u002Fgithub.com\u002FBeiKeJieDeLiuLangMao","name":"贝克街的流浪猫","isAdvertiser":false,"headline":"公众号:bbm_share 分享技术经验","gender":1,"url":"\u002Fpeople\u002F7f1731e0c12e7c7a6fa8050e2b727c23","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da_l.jpg?source=172ae18b","isOrg":false,"type":"people","levelInfo":{"nicknameColor":{"color":"","nightModeColor":""},"exp":2,"level":1,"notice":"签到领奖励","levelIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-3e1b8da6be5ec3f254999f553746f287_l.jpg"},"badge":[],"badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""},"exposedMedal":{"medalId":"1124316222665379841","medalName":"我的知乎 2019","avatarUrl":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-2592b0b52e1fac99f69b38e00252413b_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-ad363cc3088dc8de7544fd08b1c4987a_l.png?source=172ae18b","description":"参与「我的知乎 2019」即可获得"}}},"questions":{},"answers":{},"articles":{"87100741":{"trackUrl":["https:\u002F\u002Fsugar.zhihu.com\u002Fplutus_adreaper\u002Fpage_monitor_log?si=__SESSIONID__&ti=__ATOKEN__&at=view&pf=__OS__&ed=__MEMBERID__&idfa=__IDFA__&imei=__IMEI__&androidid=__ANDROIDID__&oaid=__OAID__&ci=__CREATIVEID__&zid=__ZONEID__"],"id":87100741,"title":"Seata 源码剖析之 TC TM","type":"article","articleType":"normal","excerptTitle":"","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F87100741","imageUrl":"","titleImage":"","excerpt":"\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-623b8c1089e907da1a854f5e01dc33ca_200x112.png\" data-rawwidth=\"1252\" data-rawheight=\"678\" data-size=\"normal\" data-caption=\"\" data-watermark=\"original\" data-original-src=\"v2-623b8c1089e907da1a854f5e01dc33ca\" data-watermark-src=\"v2-2974d8adb80f44565c202fdba0f155fa\" data-private-watermark-src=\"\" class=\"origin_image inline-img zh-lightbox-thumb\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-623b8c1089e907da1a854f5e01dc33ca_r.png\"\u002F\u003E引言书接上文，之前我们介绍 Seata 的理论思想，接下来，我们着重剖析一下 Seata 中的关键组件。 源码剖析Seata 整体的代码比较多, 为了避免代码堆砌影响读感, 这里我只介绍核心内容, 我会先介绍 Seata 中的核心组件 TC 和 TM, 然后再分别介绍一下 Seata 中…","created":1571281183,"updated":1571282093,"author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpicb.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da.jpg?source=172ae18b","uid":"572701747039047680","userType":"people","isFollowing":false,"urlToken":"beikejiedeliulangmao","id":"7f1731e0c12e7c7a6fa8050e2b727c23","description":"昵称：贝克街的流浪猫（贝贝猫）\n微信公众号：bbm_share\n博客：https:\u002F\u002Fwww.beikejiedeliulangmao.top\nGithub: https:\u002F\u002Fgithub.com\u002FBeiKeJieDeLiuLangMao","name":"贝克街的流浪猫","isAdvertiser":false,"headline":"公众号:bbm_share 分享技术经验","gender":1,"url":"\u002Fpeople\u002F7f1731e0c12e7c7a6fa8050e2b727c23","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da_l.jpg?source=172ae18b","isOrg":false,"type":"people","levelInfo":{"nicknameColor":{"color":"","nightModeColor":""},"exp":2,"level":1,"notice":"签到领奖励","levelIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-3e1b8da6be5ec3f254999f553746f287_l.jpg"},"badge":[],"badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""},"exposedMedal":{"medalId":"1124316222665379841","medalName":"我的知乎 2019","avatarUrl":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-2592b0b52e1fac99f69b38e00252413b_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-ad363cc3088dc8de7544fd08b1c4987a_l.png?source=172ae18b","description":"参与「我的知乎 2019」即可获得"}},"commentPermission":"all","copyrightPermission":"need_review","state":"published","imageWidth":0,"imageHeight":0,"content":"\u003Ch2\u003E引言\u003C\u002Fh2\u003E\u003Cp\u003E书接上文，之前我们介绍 Seata 的理论思想，接下来，我们着重剖析一下 Seata 中的关键组件。 \u003C\u002Fp\u003E\u003Ch2\u003E源码剖析\u003C\u002Fh2\u003E\u003Cp\u003ESeata 整体的代码比较多, 为了避免代码堆砌影响读感, 这里我只介绍核心内容, 我会先介绍 Seata 中的核心组件 TC 和 TM, 然后再分别介绍一下 Seata 中现存的两个分支事务模式 AT、TCC 的完整流程，RM 的内容会根据分支事务模式的不同分别介绍。\u003C\u002Fp\u003E\u003Ch3\u003ETC\u003C\u002Fh3\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-623b8c1089e907da1a854f5e01dc33ca_b.jpg\" data-rawwidth=\"1252\" data-rawheight=\"678\" data-size=\"normal\" data-caption=\"\" class=\"origin_image zh-lightbox-thumb\" width=\"1252\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-623b8c1089e907da1a854f5e01dc33ca_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1252&#39; height=&#39;678&#39;&gt;&lt;\u002Fsvg&gt;\" data-rawwidth=\"1252\" data-rawheight=\"678\" data-size=\"normal\" data-caption=\"\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1252\" data-original=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-623b8c1089e907da1a854f5e01dc33ca_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-623b8c1089e907da1a854f5e01dc33ca_b.jpg\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E Transaction Coordinator 整体的模块图如上所示: \u003C\u002Fp\u003E\u003Cp\u003E- Coordinator Core: 在最下面的模块是事务协调器核心代码，主要用来处理事务协调的逻辑，如分支的注册, commit, rollback 等协调活动。 \u003C\u002Fp\u003E\u003Cp\u003E- Store: 存储模块，用来将我们的数据持久化，防止重启或者宕机数据丢失。\u003C\u002Fp\u003E\u003Cp\u003E- Discover: 服务注册\u002F发现模块，用于将 Server 地址暴露给我们 Client。 \u003C\u002Fp\u003E\u003Cp\u003E- Config: 用来存储和查找我们服务端的配置。 \u003C\u002Fp\u003E\u003Cp\u003E- Lock: 锁模块，用于给 Seata 提供全局锁的功能。 \u003C\u002Fp\u003E\u003Cp\u003E- Rpc: 用于和其他端通信。 \u003C\u002Fp\u003E\u003Cp\u003E- HA-Cluster: 高可用集群，目前还没开源。为 Seata 提供可靠的高可用功能。\u003C\u002Fp\u003E\u003Ch3\u003EDiscover\u003C\u002Fh3\u003E\u003Cp\u003E首先来讲讲比较基础的 Discover 模块，又称服务注册\u002F发现模块。我们将 TC 启动之后，需要将自己的地址暴露给其他使用者 TM &amp; RM, 这部分工作就是由 Discover 模块实现的。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Einterface\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ERegistryService\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * The constant PREFIX_SERVICE_MAPPING.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPREFIX_SERVICE_MAPPING\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;vgroup_mapping.&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * The constant PREFIX_SERVICE_ROOT.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPREFIX_SERVICE_ROOT\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;service&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * The constant CONFIG_SPLIT_CHAR.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECONFIG_SPLIT_CHAR\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;.&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Register.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param address the address\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws Exception the exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eregister\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInetSocketAddress\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eaddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Unregister.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param address the address\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws Exception the exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eunregister\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInetSocketAddress\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eaddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Subscribe.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param cluster  the cluster\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param listener the listener\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws Exception the exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Esubscribe\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ecluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elistener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Unsubscribe.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param cluster  the cluster\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param listener the listener\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws Exception the exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eunsubscribe\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ecluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elistener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Lookup list.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param key the key\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the list\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws Exception the exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInetSocketAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Elookup\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Close.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws Exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eclose\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E这个模块有个核心接口 RegistryService，如上图所示: \u003C\u002Fp\u003E\u003Cp\u003E- register：TC 使用，进行服务注册。 \u003C\u002Fp\u003E\u003Cp\u003E- unregister：TC 使用，一般在JVM关闭钩子，ShutdownHook中调用。 \u003C\u002Fp\u003E\u003Cp\u003E- subscribe：TM RM 使用，注册监听事件，用来监听地址的变化。 \u003C\u002Fp\u003E\u003Cp\u003E- unsubscribe：TM RM 使用，取消注册监听事件, 一般在JVM关闭钩子，ShutdownHook中调用。 \u003C\u002Fp\u003E\u003Cp\u003E- lookup：TM RM使用，根据key查找服务地址列表。 - close：都可以使用，用于关闭Register资源。\u003C\u002Fp\u003E\u003Cp\u003E如果需要添加自己定义的服务注册\u002F发现，那么实现这个接口即可。截止目前在社区的不断开发推动下，已经有七种服务注册\u002F发现，分别是consul，etcd3，sofa，redis, zk, nacos, eruka。下面简单介绍下 redis 的实现：\u003C\u002Fp\u003E\u003Ch3\u003Eregister\u003C\u002Fh3\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eregister\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInetSocketAddress\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eaddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 校验地址是否合法\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003ENetUtil\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EvalidAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eaddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ENetUtil\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtoStringAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eaddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 获取 Redis 的实例\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003EJedis\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EjedisPool\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetResource\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 将地址注册到当前 Redis 上面。\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ehset\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EgetRedisRegistryKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EManagementFactory\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetRuntimeMXBean\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 发送注册成功的通知\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Epublish\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EgetRedisRegistryKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;-&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERedisListener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EREGISTER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclose\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E流程如下: 1. 校验地址是否合法 2. 获取 Redis 的实例，然后将地址注册到当前 Redis 上面。 3. 发送注册成功的通知\u003C\u002Fp\u003E\u003Cp\u003Eunregister接口类似，就是反方向操作, 这里不做详解。\u003C\u002Fp\u003E\u003Ch3\u003Elookup\u003C\u002Fh3\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInetSocketAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Elookup\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EConfiguration\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econfig\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConfigurationFactory\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetInstance\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 获取当前 clusterName 名字\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EPREFIX_SERVICE_ROOT\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECONFIG_SPLIT_CHAR\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPREFIX_SERVICE_MAPPING\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 判断当前 cluster 是否已经获取过了，如果获取过就从map中取\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(!\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELISTENER_SERVICE_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EcontainsKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EJedis\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EjedisPool\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetResource\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einstances\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 从 Redis 拿到地址数据，将其转换成我们所需要的\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003Einstances\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EhgetAll\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EgetRedisRegistryKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclose\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einstances\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Einstances\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisEmpty\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInetSocketAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EnewAddressSet\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EHashSet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;&gt;();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EEntry\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einstance\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einstances\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EentrySet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einstance\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EnewAddressSet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ENetUtil\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtoInetSocketAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ECLUSTER_ADDRESS_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eput\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EnewAddressSet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 将数据变更的 Listener 注册到 Redis\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003Esubscribe\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERedisListener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n            \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EonEvent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emsg\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[]\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emsgr\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emsg\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Esplit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;-&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emsgr\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E];\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EeventType\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emsgr\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E];\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Eswitch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EeventType\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERedisListener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EREGISTER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ECLUSTER_ADDRESS_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E).\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ENetUtil\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtoInetSocketAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"k\"\u003Ebreak\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERedisListener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EUN_REGISTER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ECLUSTER_ADDRESS_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E).\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eremove\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ENetUtil\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtoInetSocketAddress\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EserverAddr\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"k\"\u003Ebreak\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Edefault\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EShouldNeverHappenException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;unknown redis msg:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emsg\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E});\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EArrayList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;&gt;(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ECLUSTER_ADDRESS_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EclusterName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E订阅的过程如下: 1. 获取当前 clusterName 名字 2. 判断当前 cluster 是否已经获取过了，如果获取过就从map中取。 3. 从 Redis 拿到地址数据，将其转换成我们所需要的数据。 4. 将数据变动的 Listener 注册到 Redis\u003C\u002Fp\u003E\u003Cp\u003E其实这里面有个问题, 如果获取了服务器列表, 但是还没来得及注册订阅时, 发生了服务器列表变化, 那么客户端会感知不到, 但是这个问题在 Redis 中确实没有什么好的办法解决, 毕竟 Redis 没有提供机制来解决这个问题。但是 etcd3 中是有机制来解决的, 获取数据时能拿到当时的版本号, 然后订阅时从该版本号开始即可。然后我看了一下基于 etcd3 的 \u003Ccode\u003ERegistryService\u003C\u002Fcode\u003E 实现, 发现它并没有使用该机制。于是我提了一个 \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fgithub.com\u002Fseata\u002Fseata\u002Fissues\u002F1623\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003Eissue\u003C\u002Fa\u003E 和 \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fgithub.com\u002Fseata\u002Fseata\u002Fpull\u002F1629\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003EPR\u003C\u002Fa\u003E, 感兴趣的同学可以去看一下。\u003C\u002Fp\u003E\u003Ch3\u003Esubscribe\u003C\u002Fh3\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Esubscribe\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ecluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERedisListener\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elistener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 存储该 listener\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EredisRegistryKey\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EREDIS_FILEKEY_PREFIX\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ecluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003ELISTENER_SERVICE_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ecluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EArrayList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;&gt;());\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003ELISTENER_SERVICE_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ecluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E).\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Elistener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EthreadPoolExecutor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Esubmit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERunnable\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Erun\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EJedis\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EjedisPool\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetResource\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"c1\"\u003E\u002F\u002F 向 Redis 注册\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E                    \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Esubscribe\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ENotifySub\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELISTENER_SERVICE_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ecluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EredisRegistryKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003Ejedis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclose\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eerror\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMessage\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E});\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E流程如下: 1. 存储该 listener 2. 向 Redis 注册\u003C\u002Fp\u003E\u003Cp\u003E\u003Ccode\u003ERegistryService\u003C\u002Fcode\u003E 的主要功能就这些了,  TM 和 TC 是通过 lookup 找到服务器列表之后, 会根据设定的负载均衡策略请求 TC, 接下来我们看一看 loadbalance。\u003C\u002Fp\u003E\u003Ch3\u003Eloadbalance\u003C\u002Fh3\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Einterface\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ELoadBalance\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Select t.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param &lt;T&gt;      the type parameter\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param invokers the invokers\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the t\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws Exception the exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eselect\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einvokers\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E这个接口的实现比较简单, 目前就只有随机和轮训。\u003C\u002Fp\u003E\u003Ch3\u003EConfig\u003C\u002Fh3\u003E\u003Cp\u003E配置模块也是一个比较基础，比较简单的模块。我们需要配置一些常用的参数比如:Netty的select线程数量，work线程数量，session允许最大为多少等等，当然这些参数在 Seata 中都有自己的默认设置。\u003C\u002Fp\u003E\u003Cp\u003E同样的在 Seata 中也提供了一个接口 Configuration，通过它来存取配置内容:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Einterface\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EConfiguration\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 这里只保留了 getShort 其他都类似\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets short.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param defaultValue the default value\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param timeoutMills the timeout mills\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the short\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eshort\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetShort\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdefaultValue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtimeoutMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets short.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param defaultValue the default value\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the int\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eshort\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetShort\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eshort\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdefaultValue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets short.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the int\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eshort\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetShort\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets config.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param defaultValue the default value\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param timeoutMills the timeout mills\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the config\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdefaultValue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtimeoutMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets config.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param defaultValue the default value\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the config\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdefaultValue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets config.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param timeoutMills the timeout mills\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the config\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtimeoutMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets config.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the config\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Put config boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param content      the content\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param timeoutMills the timeout mills\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EputConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econtent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtimeoutMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Put config boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId  the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param content the content\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EputConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econtent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Put config if absent boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param content      the content\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param timeoutMills the timeout mills\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EputConfigIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econtent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtimeoutMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Put config if absent boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId  the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param content the content\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EputConfigIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econtent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Remove config boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId       the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param timeoutMills the timeout mills\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EremoveConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtimeoutMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Remove config boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EremoveConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Add config listener.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId   the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param listener the listener\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EaddConfigListener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elistener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Remove config listener.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId   the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param listener the listener\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EremoveConfigListener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elistener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets config listeners.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the config listeners\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ET\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetConfigListeners\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Gets config from sys pro.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param dataId the data id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the config from sys pro\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Edefault\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetConfigFromSysPro\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESystem\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetProperty\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EdataId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cul\u003E\u003Cli\u003EgetShort\u002FgetInt\u002FLong\u002FBoolean\u002FConfig()：通过dataId来获取对应的值。\u003C\u002Fli\u003E\u003Cli\u003EputConfig：用于添加配置。\u003C\u002Fli\u003E\u003Cli\u003EremoveConfig：删除一个配置。\u003C\u002Fli\u003E\u003Cli\u003Eadd\u002Fremove\u002Fget ConfigListener：添加\u002F删除\u002F获取 配置监听器，一般用来监听配置的变更。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003E目前为止有四种方式获取 Config：File(文件获取), Nacos, Apollo, ZK，etcd。在 Seata 中首先现在项目 resources 下保存一个 registry.conf 文件，在该文件中配置具体使用 Config 接口哪个实现类。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E\u002F\u002F registry.conf 相关内容\nconfig {\n  # file、nacos 、apollo、zk、consul\n  type = &#34;file&#34;\n\n  file {\n    name = &#34;file.conf&#34;\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003Econfig 相关的内容我们就不多描述了, 就是简单地存取数据, 发生变化时通知各个节点进行改变。\u003C\u002Fp\u003E\u003Ch3\u003EStore\u003C\u002Fh3\u003E\u003Cp\u003E存储层的实现对于 Seata 是否高性能，是否可靠非常关键。\u003C\u002Fp\u003E\u003Cp\u003E如果存储层没有实现好，那么如果发生宕机，在 TC 中正在进行分布式事务处理的数据将会被丢失，既然使用了分布式事务，那么其肯定不能容忍丢失。如果存储层实现好了，但是其性能有很大问题，RM 可能会发生频繁回滚那么其完全无法应对高并发的场景。\u003C\u002Fp\u003E\u003Cp\u003E在 Seata 中默认提供了文件方式的存储，下面我们定义我们存储的数据为 Session，而我们的TM创造的全局事务数据叫 GlobalSession，RM 创造的分支事务叫 BranchSession，一个 GlobalSession 可以拥有多个 BranchSession。我们的目的就是要将这么多 Session 存储下来。\u003C\u002Fp\u003E\u003Cp\u003ESeata 中目前有 2 种实现方案, 一种是基于文件的, 一种是基于 DB 的, 我们接下来会分别介绍。\u003C\u002Fp\u003E\u003Ch3\u003EFile\u003C\u002Fh3\u003E\u003Cp\u003E基于文件的实现是 \u003Ccode\u003EFileTransactionStoreManager\u003C\u002Fcode\u003E, 它可以使用同步刷盘或异步刷盘的策略，每当有 Session 的状态的更新时，它都会将变化的内容存储起来。为了防止存储文件的无限增殖，当达到一定条件时，它会另打开一个文件从头开始记录，并将之前的文件保存起来。这里有一个非常巧妙的设计，就是该方案既能保证所有超时事务不丢，只有已完成的事务被清除，同时文件的大小也得到了控制。我们会结合代码来介绍 Seata 是如何做到的。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EwriteSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESessionStorable\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 靠锁保证安全\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003EwriteSessionLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EcurFileTrxNum\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 实际的写数据过程，将编码后的比特数组写入 FileChannel\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(!\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EwriteDataFile\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionWriteStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E).\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eencode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElastModifiedTime\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESystem\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EcurrentTimeMillis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EcurFileTrxNum\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFILE_TRX_NUM\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EincrementAndGet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 如果当前事务存储文件已经累计记录一定数量的事务，并且该文件使用时间达标，则进行当前文件的保存和新文件的创建\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EcurFileTrxNum\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E%\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPER_FILE_BLOCK_SIZE\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESystem\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EcurrentTimeMillis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtrxStartTimeMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMAX_TRX_TIMEOUT_MILLS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EsaveHistory\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eexx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eerror\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;writeSession error,&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eexx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMessage\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EwriteSessionLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eunlock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 实际刷盘过程，根据配置，可以是同步也可以是异步\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003EflushDisk\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EcurFileTrxNum\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EcurrFileChannel\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E上面的代码，就是存储 Session 的入口，其中 \u003Ccode\u003ElogOperation\u003C\u002Fcode\u003E 可以是增加、删除、更新，\u003Ccode\u003Esession\u003C\u002Fcode\u003E 可以是 GlobalSession，也可以是 BranchSession。其中就 3 个关键函数，\u003Ccode\u003EwriteDataFile\u003C\u002Fcode\u003E，\u003Ccode\u003EsaveHistory\u003C\u002Fcode\u003E，\u003Ccode\u003EflushDisk\u003C\u002Fcode\u003E，我们分别介绍一下它们。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EwriteDataFile\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Ebyte\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[]\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E||\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elength\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EInteger\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EMAX_VALUE\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E3\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EByteBuffer\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 有一个默认缓存，如果该缓存太小，则临时申请\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elength\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E4\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMAX_WRITE_BUFFER_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002FallocateNew\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EByteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EallocateDirect\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elength\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E4\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EwriteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002Frecycle\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclear\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputInt\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elength\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eput\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EwriteDataFileByBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EwriteDataFileByBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EByteBuffer\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eflip\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eretry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eretry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMAX_WRITE_RETRY\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eretry\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E++)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F 循环写入\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"k\"\u003Ewhile\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EhasRemaining\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EcurrFileChannel\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ewrite\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EIOException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eexx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eerror\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;write data file error:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eexx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMessage\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eerror\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;write dataFile failed,retry more than :&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMAX_WRITE_RETRY\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E\u003Ccode\u003EwriteDataFile\u003C\u002Fcode\u003E 的实现很简单，就是同步写入 FileChannel。接下来看一下最妙的 \u003Ccode\u003EsaveHistory\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EsaveHistory\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIOException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresult\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 找到内存中保存的所有超时的事务，这些事务是需要回滚的，不能清除，但是其他完成的事务是可以清除的，这个保存过程实际上就是将超时事务追加到当前文件的结尾\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003Eresult\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EfindTimeoutAndSave\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 然后异步关闭文件\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003EwriteDataFileRunnable\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECloseFileRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EcurrFileChannel\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EcurrRaf\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 同时，给文件改名为historyFullFileName，替换掉旧的historyFullFile，同一时刻，Seata 只会有 2 个事务存储文件，一个是currentDataFile代表正在使用的文件，一个是historyFullFile，存储了过往的所有可能有用的 Session\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003EFiles\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Emove\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EcurrDataFile\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtoPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFile\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EhisFullFileName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E).\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtoPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EStandardCopyOption\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EREPLACE_EXISTING\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EIOException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eexx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eerror\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;save history data file error,&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eexx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMessage\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eresult\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EinitFile\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EcurrFullFileName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresult\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"c1\"\u003E\u002F\u002F 找到所有超时的 Session 存储起来\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EfindTimeoutAndSave\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIOException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EGlobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalSessionsOverMaxTimeout\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EsessionManager\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EfindGlobalSessions\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESessionCondition\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMAX_TRX_TIMEOUT_MILLS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ECollectionUtils\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisEmpty\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalSessionsOverMaxTimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Ebyte\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[]&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElistBytes\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EArrayList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;&gt;();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtotalSize\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 1. find all data and merge\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EGlobalSession\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalSessionsOverMaxTimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ETransactionWriteStore\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalWriteStore\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionWriteStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EGLOBAL_ADD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kt\"\u003Ebyte\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[]\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalWriteStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eencode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElistBytes\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EtotalSize\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elength\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EINT_BYTE_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSessIonsOverMaXTimeout\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetSortedBranches\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSessIonsOverMaXTimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBranchSession\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSessIonsOverMaXTimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ETransactionWriteStore\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchWriteStore\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionWriteStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EBRANCH_ADD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchWriteStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eencode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ElistBytes\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EtotalSize\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elength\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EINT_BYTE_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 2. batch write\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003EByteBuffer\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EByteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EallocateDirect\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtotalSize\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Ebyte\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[]\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebytes\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElistBytes\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputInt\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebytes\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elength\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eput\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebytes\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EwriteDataFileByBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbyteBuffer\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EcurrFileChannel\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eforce\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E现在我们知道 Seata 同时最多有2个存储文件，一个是 currentDataFile 一个是 historyFullFile，currentDataFile 存储了最新的数据，而 historyFullFile 相较于 currentDataFile，还存储了之前过期的所有 Session。任何时候，如果 TC 宕机，重启时只要先读取 historyFullFile，再读取 currentDataFile 就能恢复所有数据。\u003C\u002Fp\u003E\u003Cp\u003E替换 historyFullFile 时，因为会将所有超时的 Session 信息先写入 currentDataFile，然后才会将 currentDataFile 改名为 historyFullFile 并替换掉之前的 oldHistoryFullFile，这样所有过期 Session 就被延续下去了，实际上 Session 过期时间和新建 currentDataFile 的时间是一致的，都是 30 分钟，这样再进行 historyFullFile 替换时，之前的 oldHistoryFullFile 实际上只会存在超时 Session 和完成的 Session，所有超时 Session 已经被记录在新的 historyFullFile 中了，而完成的 Session 会在替换时，随着 oldHistoryFullFile 一起被删除。这就是为什么我觉得这个地方的设计十分巧妙。\u003C\u002Fp\u003E\u003Cp\u003E最后刷盘的过程也很简单。根据配置，如果是同步刷盘会用 \u003Ccode\u003EFuture#get\u003C\u002Fcode\u003E 阻塞等待，否则异步进行，\u003Ccode\u003EwriteDataFileRunnable\u003C\u002Fcode\u003E 内部有一个阻塞队列，会有一个线程循环从中提取任务并执行，应该不难理解吧。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EflushDisk\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EcurFileNum\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFileChannel\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EcurrFileChannel\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EFLUSH_DISK_MODE\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFlushDiskMode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ESYNC_MODEL\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ESyncFlushRequest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EsyncFlushRequest\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESyncFlushRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EcurFileNum\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EcurrFileChannel\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EwriteDataFileRunnable\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EsyncFlushRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EsyncFlushRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EwaitForFlush\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMAX_WAIT_FOR_FLUSH_TIME_MILLS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EwriteDataFileRunnable\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EAsyncFlushRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EcurFileNum\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EcurrFileChannel\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch3\u003EDB\u003C\u002Fh3\u003E\u003Cp\u003E接下来，我们看一下基于 DB 的实现。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EwriteSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESessionStorable\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EGLOBAL_ADD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElogStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EinsertGlobalTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EconvertGlobalTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EGLOBAL_UPDATE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElogStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EupdateGlobalTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EconvertGlobalTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EGLOBAL_REMOVE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElogStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EdeleteGlobalTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EconvertGlobalTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EBRANCH_ADD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElogStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EinsertBranchTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EconvertBranchTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EBRANCH_UPDATE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElogStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EupdateBranchTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EconvertBranchTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EBRANCH_REMOVE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ElogStore\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EdeleteBranchTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EconvertBranchTransactionDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EStoreException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Unknown LogOperation:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElogOperation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E基于 DB 的实现相较于基于文件的实现就显得朴实无华，\u003Ccode\u003ElogStore\u003C\u002Fcode\u003E 实际上就是一个 DAO 层的接口，对应了数据的 CRUD，在重启恢复时只不过是按照条件遍历 DB 中的所有数据，进行 Session 恢复。\u003C\u002Fp\u003E\u003Ch3\u003ELock\u003C\u002Fh3\u003E\u003Cp\u003E大家知道数据库实现隔离级别主要是通过锁来实现的，同样的在分布式事务框架 Seata 中要实现隔离级别也需要通过锁。一般在数据库中数据库的隔离级别一共有四种:读未提交，读已提交，可重复读，串行化。在 Seata 中可以保证写操作的互斥性，而读的隔离级别一般是读未提交，但是提供了达到读已提交隔离的手段。\u003C\u002Fp\u003E\u003Cp\u003ELock 模块也就是 Seata 实现隔离级别的核心模块。在 Lock 模块中提供了一个接口用于管理我们的锁:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Einterface\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ELockManager\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Acquire lock boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param branchSession the branch session\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws TransactionException the transaction exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EacquireLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBranchSession\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Un lock boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param branchSession the branch session\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws TransactionException the transaction exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EreleaseLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBranchSession\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Un lock boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param globalSession the global session\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws TransactionException the transaction exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EreleaseGlobalSessionLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EGlobalSession\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Is lockable boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param xid        the xid\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param resourceId the resource id\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param lockKey    the lock key\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws TransactionException the transaction exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EisLockable\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EresourceId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Clean all locks.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws TransactionException the transaction exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EcleanAllLocks\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cul\u003E\u003Cli\u003EacquireLock：用于对我们的 BranchSession 加锁，这里虽然是传的分支事务 Session，实际上是对分支事务操作的数据行加锁，成功返回 true。\u003C\u002Fli\u003E\u003Cli\u003EisLockable：根据事务 ID，资源 ID，锁住的Key来查询是否已经加锁。\u003C\u002Fli\u003E\u003Cli\u003EreleaseLock: 释放分支事务的所有锁。\u003C\u002Fli\u003E\u003Cli\u003EreleaseGlobalSessionLock： 释放全局事务的所有分支事务的锁。\u003C\u002Fli\u003E\u003Cli\u003EcleanAllLocks：清除所有的锁。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003E在 Seata 中, LockManager 下层有使用的锁有两种实现, 一种是基于内存的锁(Session 存储模式为 File 时使用), 一种是基于 DB 的(Session 存储模式为 DB 时使用)，它们都实现了 \u003Ccode\u003ELocker\u003C\u002Fcode\u003E 接口:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Einterface\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ELocker\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Acquire lock boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param rowLock the row lock\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EacquireLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Un lock boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param rowLock the row lock\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EreleaseLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Is lockable boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param rowLock the row lock\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EisLockable\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Clean all locks boolean.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the boolean\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EcleanAllLocks\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E我们可以看到, 在 Locker 中将 branchSession 的概念剥离出去了, 只保留了 RowLock 的概念, 责任更加单一, 接下来我们分别看看它的实现类。\u003C\u002Fp\u003E\u003Ch3\u003EMemoryLocker\u003C\u002Fh3\u003E\u003Cp\u003E内存锁的实现全都存在一个锁 Map 中, 它是整个 Locker 的实现核心, 我们先来看一下它的结构:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"cm\"\u003E\u002F* resourceId *\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"cm\"\u003E\u002F* tableName *\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInteger\u003C\u002Fspan\u003E \u003Cspan class=\"cm\"\u003E\u002F* bucketId *\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"cm\"\u003E\u002F* pk *\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E\u002F* transactionId *\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;&gt;&gt;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ELOCK_MAP\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;&gt;();\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E我们可以看到, 通过这个 Map 将锁的粒度控制的很小, 最外层 Map 的 key 是 resourceId, 也就是对应了一个 RM, 然后第二层 Map 的 key 是表名, 对应了 RM 上操作的一张表, 下一层 Map 的 key 是 BucketID, Seata 根据表主键哈希值进行了分桶, 让冲突的概率降低, 默认有 128 个桶, 最后一层 Map 的 key 才是主键, Value 是持有该主键锁的事务 ID。\u003C\u002Fp\u003E\u003Cp\u003E明确了锁存储的数据结构后, 再分析加解锁过程就清晰多了:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F MemoryLocker\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EacquireLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErowLocks\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ECollectionUtils\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisEmpty\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErowLocks\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002Fno lock\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EresourceId\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetResourceId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Elong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionId\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTransactionId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbucketHolder\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetLockHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInteger\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdbLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELOCK_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EresourceId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 确认 RM 对应的 Map 是否已经构建\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EdbLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ELOCK_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EresourceId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInteger\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;&gt;());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EdbLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELOCK_MAP\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EresourceId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERowLock\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elock\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErowLocks\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtableName\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTableName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epk\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetPk\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInteger\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtableLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdbLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtableName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 确认表对应的 Map 是否已经构建好\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtableLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EdbLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtableName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInteger\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;());\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EtableLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdbLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtableName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbucketId\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epk\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EhashCode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E%\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EBUCKET_PER_TABLE\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbucketLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtableLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbucketId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 确认 bucket map 是否已经构建好\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbucketLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EtableLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbucketId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;());\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EbucketLockMap\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtableLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbucketId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 实际加锁过程\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EpreviousLockTransactionId\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbucketLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epk\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EpreviousLockTransactionId\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002FNo existing lock, and now locked by myself\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EkeysInHolder\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbucketHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbucketLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EkeysInHolder\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EbucketHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EputIfAbsent\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbucketLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConcurrentSet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;());\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EkeysInHolder\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbucketHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbucketLockMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EkeysInHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epk\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EpreviousLockTransactionId\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F Locked by me before\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"k\"\u003Econtinue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Global lock on [&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtableName\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epk\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;] is holding by &#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EpreviousLockTransactionId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"c1\"\u003E\u002F\u002F Release all acquired locks.\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E                \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eunlock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFrameworkException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E我们可以看到, 加锁的过程无非就是确认各级 Map 中是否有自己要的数据, 如果没有就用 putIfAbsent 添加进去, 最后到主键所在的 bucketMap 时, 才是真正加锁并确认的过程: 1. 使用 putIfAbsent 将自己的 transactionId 填入 bucketLockMap 2. 如果 previousLockTransactionId 为空, 说明自己获得了锁, 把自己获得的锁记录在 branchSession 中, 方便释放时查找 3. 如果 previousLockTransactionId 和自己的 transactionId 相同, 说明这个锁之前就被自己持有了, 直接返回即可 4. 否则, 发生了锁冲突, 释放自己之前获取到的所有锁\u003C\u002Fp\u003E\u003Cp\u003E其实, 这个实现中原来有一个死锁的 bug, 之前给 bucket Map 的加锁过程, 使用了 Synchronized block, 如果两个分支 Session 要同时锁一个表的相同数据, 并且加锁的顺序不同(BS1: row1, row2, row3; BS2: row3, row2, row1), 就会发生死锁。\u003C\u002Fp\u003E\u003Cp\u003E导致这个 bug 的原因是Synchronized block 的作用范围有误, 将解锁过程也包在了该代码块中。所以, 当时我就提了 \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fgithub.com\u002Fseata\u002Fseata\u002Fissues\u002F1603\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003Eissue\u003C\u002Fa\u003E 和 \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fgithub.com\u002Fseata\u002Fseata\u002Fpull\u002F1605\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003Epr\u003C\u002Fa\u003E, 有兴趣的同学可以去看一看。\u003C\u002Fp\u003E\u003Cp\u003E释放锁的过程就很简单了, 遍历 branchSession 中持有的所有锁, 并依次释放它们。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F MemoryLocker\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EreleaseLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErowLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 取出所有持有的锁\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockHolder\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetLockHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElockHolder\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E||\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EIterator\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EEntry\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eit\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EentrySet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eiterator\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 挨个释放锁\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"k\"\u003Ewhile\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EhasNext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EEntry\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eentry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Enext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EConcurrentHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebucket\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eentry\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekeys\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eentry\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetValue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekeys\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F remove lock only if it locked by myself\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003Ebucket\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eremove\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTransactionId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003ElockHolder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclear\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E这里大家可能会有疑问, 存在内存中的锁, 如果发生了崩溃, 重启的时候锁不就没了么, 其实 Seata 在重启并恢复 Session 的同时, 也会按顺序恢复各个 Session 的锁, 下面只会展示核心代码。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * io.seata.server.session.SessionHolder#reload\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Eprotected\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ereload\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F ...\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"n\"\u003ECollection\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EGlobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EreloadedSessions\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EROOT_SESSION_MANAGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EallSessions\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EreloadedSessions\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EreloadedSessions\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisEmpty\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EreloadedSessions\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EforEach\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EGlobalStatus\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalStatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetStatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Eswitch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalStatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EUnKnown\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECommitted\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECommitFailed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERollbacked\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERollbackFailed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETimeoutRollbacked\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETimeoutRollbackFailed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFinished\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EShouldNeverHappenException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Reloaded Session should NOT be &#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalStatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EAsyncCommitting\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"c1\"\u003E\u002F\u002F 恢复未完成的异步提交过程\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E                        \u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EaddSessionLifecycleListener\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EgetAsyncCommittingSessionManager\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003EgetAsyncCommittingSessionManager\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EaddGlobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EShouldNeverHappenException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ebreak\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Edefault\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EArrayList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EbranchSessions\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetSortedBranches\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"c1\"\u003E\u002F\u002F Lock, 重新加锁\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E                    \u003Cspan class=\"n\"\u003EbranchSessions\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EforEach\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                            \u003Cspan class=\"n\"\u003EbranchSession\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Elock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                            \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EShouldNeverHappenException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E});\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"c1\"\u003E\u002F\u002F ...\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\"o\"\u003E});\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch3\u003EDataBaseLocker\u003C\u002Fh3\u003E\u003Cp\u003E和 SessionManager 的实现相同, DataBaseLocker 的加锁过程实际上就是一个对 DB 增删数据。因为这部分比较简单, 所以我们只展示加锁的最核心内容: \u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F LockStoreDataBaseDAO\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Eprotected\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EdoAcquireLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EConnection\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econn\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELockDO\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EPreparedStatement\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002Finsert\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EinsertLockSQL\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELockStoreSqls\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetInsertLockSQL\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ElockTable\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EdbType\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Econn\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EprepareStatement\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EinsertLockSQL\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetLong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTransactionId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetLong\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E3\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetBranchId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E4\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetResourceId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E5\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTableName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E6\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetPk\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003E7\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ElockDO\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetRowKey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EexecuteUpdate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESQLException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EStoreException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003Eps\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclose\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESQLException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch3\u003ERpc\u003C\u002Fh3\u003E\u003Cp\u003E保证 Seata 高性能的关键之一也是使用了 Netty 作为 RPC 框架，采用默认配置的线程模型如下图所示： \u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpicb.zhimg.com\u002Fv2-5a4632215072bd0a14b40580ba00b05d_b.jpg\" data-rawwidth=\"1262\" data-rawheight=\"486\" data-size=\"normal\" data-caption=\"\" class=\"origin_image zh-lightbox-thumb\" width=\"1262\" data-original=\"https:\u002F\u002Fpicb.zhimg.com\u002Fv2-5a4632215072bd0a14b40580ba00b05d_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;1262&#39; height=&#39;486&#39;&gt;&lt;\u002Fsvg&gt;\" data-rawwidth=\"1262\" data-rawheight=\"486\" data-size=\"normal\" data-caption=\"\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1262\" data-original=\"https:\u002F\u002Fpicb.zhimg.com\u002Fv2-5a4632215072bd0a14b40580ba00b05d_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpicb.zhimg.com\u002Fv2-5a4632215072bd0a14b40580ba00b05d_b.jpg\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E 如果采用默认的基本配置, 那么会有一个 Acceptor 线程用于处理客户端的链接，会有 cpu*2 数量的 NIO-Thread，在这些 NIO-Thread 线程中不会做业务太重的事情，只会做一些速度比较快的事情，比如编解码，心跳事件，和 TM 注册。一些比较费时间的业务操作将会交给业务线程池，默认情况下业务线程池配置为最小线程为 100，最大为 500。\u003C\u002Fp\u003E\u003Cp\u003E关于 Netty 的使用基础, 我们这里就不详细介绍了, 简单说就是对于每个连接都会绑定上数据的 handler, 它会按照责任链的原则, 顺着 handler 的绑定顺序, 处理数据, 这里简单看下它都绑定了什么 handler:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F Rpc Server 和 Rpc Client\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ech\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Epipeline\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EaddLast\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIdleStateHandler\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EnettyServerConfig\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetChannelMaxReadIdleSeconds\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EaddLast\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EProtocolV1Decoder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EaddLast\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EProtocolV1Encoder\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EaddList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E我们可以看到, 它们都绑定了心跳组件 IdleStateHandler, 然后是编解码器, 最后是 Server(TC) 和 Client(TM RM), 它们会拿到原始的请求和回应数据, 据此来进行业务交互。\u003C\u002Fp\u003E\u003Cp\u003E前面介绍 Discover 模块时, 我们知道 Server 是将自己注册到注册中心, 然后 Client 订阅更新, 并得到 Server 的列表, 最后通过负载均衡选择一个 Server 进行连接。当连接建立成功后, Server 会保存所有的连接, 在需要进行分支回滚和提交时, 从所有 RM 的连接记录中, 找到对应 RM 的所有连接, 它会首先寻找最原始的 RM 节点, 如果该节点宕机了, 它会找到该 RM 的其他节点, 然后发送分支提交请求。\u003C\u002Fp\u003E\u003Ch3\u003EHA-Cluster\u003C\u002Fh3\u003E\u003Cp\u003E尚未实现\u003C\u002Fp\u003E\u003Ch3\u003EMetrics\u003C\u002Fh3\u003E\u003Cp\u003E统计接口目前的实现也很简单, 就是在内存中计数, 然后支持通过 HTTP 获取统计数据，这部分很简单我就不展示了。\u003C\u002Fp\u003E\u003Ch3\u003ECoordinator Core\u003C\u002Fh3\u003E\u003Cp\u003E在 TC 端, 大部分工作都是响应 TM 的请求, 然后发送提交回滚请求给 RM，下达提交或回滚命令, 这些部分我们会在后面的 AT 模式串讲 和 TCC 模式串讲中介绍, 本节主要看一下在 TC 模块中, 自主进行的一些工作。\u003C\u002Fp\u003E\u003Cp\u003E当 TC 启动时, 先恢复本机的 Session, 然后启动 RPC Server, 最后注册自己的地址到注册中心, 这些我们前面已经介绍过了, 除此之外, TC 还会启动几个后台线程, 这些线程保证了 TC 的协调工作能够在发生错误时, 最终能顺利完成, 我们来看一下这部分的代码:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * Init.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Einit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EretryRollbacking\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EscheduleAtFixedRate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EhandleRetryRollbacking\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Exception retry rollbacking ... &#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E},\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EROLLBACKING_RETRY_PERIOD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETimeUnit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EMILLISECONDS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"n\"\u003EretryCommitting\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EscheduleAtFixedRate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EhandleRetryCommitting\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Exception retry committing ... &#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E},\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECOMMITTING_RETRY_PERIOD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETimeUnit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EMILLISECONDS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"n\"\u003EasyncCommitting\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EscheduleAtFixedRate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EhandleAsyncCommitting\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Exception async committing ... &#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E},\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EASYN_COMMITTING_RETRY_PERIOD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETimeUnit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EMILLISECONDS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"n\"\u003EtimeoutCheck\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EscheduleAtFixedRate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EtimeoutCheck\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Exception timeout checking ... &#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E},\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETIMEOUT_RETRY_PERIOD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETimeUnit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EMILLISECONDS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"n\"\u003EundoLogDelete\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EscheduleAtFixedRate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EundoLogDelete\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Exception undoLog deleting ... &#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E},\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EUNDOLOG_DELAY_DELETE_PERIOD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EUNDOLOG_DELETE_PERIOD\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETimeUnit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EMILLISECONDS\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E我们可以看到, 这些后台任务分别是回滚重试, 提交重试, 异步提交, 超时检测, 删除没用的 AT 模式 undo log。\u003C\u002Fp\u003E\u003Ch3\u003ETM\u003C\u002Fh3\u003E\u003Cp\u003ETM 和 TC 一样是一个共通的模块, 无论是 AT 模式还是 TCC 模式都需要使用 TM 模块。\u003C\u002Fp\u003E\u003Cp\u003E首先 TM 在启动的时候会去连接 TC Server, 然后然后通过该 TM Client 与 TC 模块进行通讯。在 TM 模块中最核心的接口就是 \u003Ccode\u003EGlobalTransaction\u003C\u002Fcode\u003E, 里面包含了全局事务的创建, 提交, 回滚过程, 其实质就是向 TC 发送 RPC 请求。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EDefaultGlobalTransaction\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransaction\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 只保留核心内容...\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebegin\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Erole\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransactionRole\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ELauncher\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003Echeck\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisDebugEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Edebug\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Ignore Begin(): just involved in global transaction [&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;]&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIllegalStateException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIllegalStateException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionManager\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ebegin\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Estatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalStatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EBegin\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ebind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisInfoEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Begin new global transaction [&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;]&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ecommit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Erole\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransactionRole\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EParticipant\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F Participant has no responsibility of committing\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisDebugEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Edebug\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Ignore Commit(): just involved in global transaction [&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;]&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIllegalStateException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\"n\"\u003Estatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionManager\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ecommit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eunbind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisInfoEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;[&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;] commit status:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Erollback\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Erole\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransactionRole\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EParticipant\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F Participant has no responsibility of committing\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisDebugEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Edebug\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Ignore Rollback(): just involved in global transaction [&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;]&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIllegalStateException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\"n\"\u003Estatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionManager\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Erollback\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eequals\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eunbind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisInfoEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;[&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;] rollback status:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E我们可以看到, 这个接口中实际上没做什么实际的事, 它调用 transactionManager 发送消息, 然后将涉及到的全局事务 XID 保存起来, 我们看看它把数据存在什么地方了:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EThreadLocalContextCore\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EContextCore\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EThreadLocal\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EthreadLocal\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EThreadLocal\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;&gt;()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kd\"\u003Eprotected\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EinitialValue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EHashMap\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"o\"\u003E};\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eput\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evalue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EthreadLocal\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eput\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evalue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EthreadLocal\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eremove\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EthreadLocal\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eremove\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E看上去, 它是将 XID 存在了 ThreadLocal 中, 这样在整个 RPC 调用的上下文中都能获取到 XID。接下来, 我们看看下层的 transactionManager 都做了什么:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EDefaultTransactionManager\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionManager\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F All PRCs here\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebegin\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EapplicationId\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionServiceGroup\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EGlobalBeginRequest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Erequest\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalBeginRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Erequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetTransactionName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003Erequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetTimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Etimeout\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EGlobalBeginResponse\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EGlobalBeginResponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EsyncCall\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Erequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetResultCode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EResultCode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EFailed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETransactionExceptionCode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EBeginFailed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMsg\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalStatus\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ecommit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EGlobalCommitRequest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalCommit\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalCommitRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EglobalCommit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EGlobalCommitResponse\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EGlobalCommitResponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EsyncCall\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalCommit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetGlobalStatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalStatus\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Erollback\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EGlobalRollbackRequest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalRollback\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalRollbackRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EglobalRollback\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EGlobalRollbackResponse\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EGlobalRollbackResponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EsyncCall\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalRollback\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetGlobalStatus\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E可以看到, TransactionManager 才是真正做实事的, 消息的发送工作都在这里完成。好了, 至此我们知道了哪个接口管理着全局事务的记录, 哪个接口真正进行 RPC 调用, 那么谁才是这些接口的真正调用者呢? Seata 使用了模板方法模式来进行这部分工作:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ETransactionalTemplate\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"cm\"\u003E\u002F**\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * Execute object.\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @param business the business\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @return the object\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     * @throws TransactionalExecutor.ExecutionException the execution exception\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E     *\u002F\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EObject\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eexecute\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETransactionalExecutor\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebusiness\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EThrowable\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 1. get or create a transaction\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003EGlobalTransaction\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etx\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransactionContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCurrentOrCreate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\"c1\"\u003E\u002F\u002F 1.1 get transactionInfo\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E        \u003Cspan class=\"n\"\u003ETransactionInfo\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtxInfo\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebusiness\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTransactionInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtxInfo\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EShouldNeverHappenException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;transactionInfo does not exist&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F 2. begin transaction\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003EbeginTransaction\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtxInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\"n\"\u003EObject\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ers\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n                \u003Cspan class=\"c1\"\u003E\u002F\u002F Do Your Business\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E                \u003Cspan class=\"n\"\u003Ers\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebusiness\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eexecute\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EThrowable\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eex\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n                \u003Cspan class=\"c1\"\u003E\u002F\u002F 3.the needed business exception to rollback.\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E                \u003Cspan class=\"n\"\u003EcompleteTransactionAfterThrowing\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EtxInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Etx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eex\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eex\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F 4. everything is fine, commit.\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003EcommitTransaction\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Etx\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ers\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F5. clear\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003EtriggerAfterCompletion\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EcleanUp\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E该模板的工作流程如下: 1. 看看当前是不是已经在一个分布式事务中了, 如果是, 则复用现存的全局事务, 否则创建新的     - 什么时候会出现已经存在全局事务的情况呢? 假设 A 调用了 B, A 创建了全局事务 GT1, B 碰巧也执行了上述的模板, 这时候 B 就不会创建新的全局事务, 而是使用 GT1, 这实际上是前面提到的事物的传播 2. 如果是自己创建的全局事务, 则发 RPC 开始事务, 如果不是自己创建的则什么都不干 3. 执行真正的业务逻辑 4. 如果发生了异常, 如果自己创建全局事务, 才负责回滚, 否则就只管异常外抛 5. 如果没发生异常, 如果自己创建全局事务, 才负责提交, 否则就什么都不做 6. 清理工作\u003C\u002Fp\u003E\u003Cp\u003E我们看到, 该模板实际上是业务服务的完整执行流程, 那我们每次都要自己在代码中通过该模板接口执行自己的业务代码吗? 当然不用, 实际上 Seata 基于 Spring 切面, 已经帮我们做了这些事, 我们只需要使用 GlobalTransactional 注解就够了, 接下来我们看看这部分内容:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EGlobalTransactionalInterceptor\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMethodInterceptor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E\u002F\u002F 只保留核心代码\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EObject\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Einvoke\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMethodInvocation\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EThrowable\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EClass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;?&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtargetClass\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetThis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EAopUtils\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTargetClass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetThis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EMethod\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EspecificMethod\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EClassUtils\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMostSpecificMethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtargetClass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMethod\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emethod\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EBridgeMethodResolver\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EfindBridgedMethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EspecificMethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransactional\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTransactionalAnnotation\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EgetAnnotation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Emethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransactional\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalLock\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalLockAnnotation\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EgetAnnotation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Emethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalTransactionalAnnotation\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EhandleGlobalTransaction\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTransactionalAnnotation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalLockAnnotation\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EhandleGlobalLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eproceed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EObject\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EhandleGlobalLock\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMethodInvocation\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalLockTemplate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eexecute\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eproceed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EThrowable\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Einstanceof\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERuntimeException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E});\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EObject\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EhandleGlobalTransaction\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMethodInvocation\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E\n                                           \u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EGlobalTransactional\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTrxAnno\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EThrowable\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionalTemplate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eexecute\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionalExecutor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n                \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EObject\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eexecute\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EThrowable\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eproceed\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n                \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTrxAnno\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(!\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EStringUtils\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisNullOrEmpty\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EformatMethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EmethodInvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetMethod\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n                \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n                \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionInfo\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetTransactionInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003ETransactionInfo\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionInfo\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ETransactionInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EtransactionInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetTimeOut\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EglobalTrxAnno\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtimeoutMills\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EtransactionInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERollbackRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErollbackRules\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELinkedHashSet\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;&gt;();\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EClass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;?&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTrxAnno\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ErollbackFor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ErollbackRules\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERollbackRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTrxAnno\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ErollbackForClassName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ErollbackRules\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERollbackRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EClass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;?&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTrxAnno\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EnoRollbackFor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ErollbackRules\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ENoRollbackRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EglobalTrxAnno\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EnoRollbackForClassName\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ErollbackRules\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ENoRollbackRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErbRule\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E));\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EtransactionInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetRollbackRules\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErollbackRules\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EtransactionInfo\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E});\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ecatch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETransactionalExecutor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EExecutionException\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ETransactionalExecutor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ECode\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ecode\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Eswitch\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ecode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERollbackDone\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetOriginalException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EBeginFailure\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EfailureHandler\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EonBeginFailure\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTransaction\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCause\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCause\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECommitFailure\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EfailureHandler\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EonCommitFailure\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTransaction\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCause\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCause\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERollbackFailure\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003EfailureHandler\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EonRollbackFailure\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetTransaction\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCause\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ee\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetCause\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Edefault\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Ethrow\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EShouldNeverHappenException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;Unknown TransactionalExecutor.Code: &#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ecode\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E我们可以看到, 上面的就是全局事务的拦截器, 它扫描 \u003Ccode\u003EGlobalTransactional\u003C\u002Fcode\u003E 和 \u003Ccode\u003EGlobalLock\u003C\u002Fcode\u003E, 如果是 \u003Ccode\u003EGlobalTransactional\u003C\u002Fcode\u003E 则用 transactionalTemplate 来执行真正的业务代码, 此外还从注解中拿出配置的回滚条件, 超时时间等配置, 给 transactionalTemplate 使用。\u003C\u002Fp\u003E\u003Cp\u003E大家也看到了这个拦截器中, 还有一个 globalLockTemplate, 实际上这个是在 RM 中使用的, 至于为什么, 使用我们在前面的理论环节已经介绍了, 这里就不赘述了, 而且该模板代码也很简单, 就是加锁-&gt;执行-&gt;放锁, 并且这里的加锁和放锁只是改变 Context 中的标志位, 真正通过 RPC 进行锁确认的过程, 我们后面会介绍。\u003C\u002Fp\u003E\u003Cp\u003E至此, 我们知道了 TM 是如何觉察到全局事务需求(GlobalTransactional 注解), 如何创建全局事务(RPC 调用 TC 接口), 如何通过模板方法模式完成对业务的封装(GlobalTransactionTemplate)。那么还有一个问题, 事务信息是怎么传递的呢, TM 怎么将全局事务 XID 传递给 RPC 的提供者的呢? 这部分, 根据 RPC 框架的不同, 需要不同的实现, 但是本质上都是一样的, 拦截 RPC 的调用过程, 在 RPC 请求中加一个隐藏属性来存储 XID, RPC 的提供方从请求中获取到该隐藏属性, 然后存储在事务 Context 的 ThreadLocal 中, 我们以 Dubbo 为例, 看一看它是怎么做的:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"nd\"\u003E@Activate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Egroup\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EConstants\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EPROVIDER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EConstants\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ECONSUMER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E},\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eorder\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003E100\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ETransactionPropagationFilter\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFilter\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELogger\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ELoggerFactory\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetLogger\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETransactionPropagationFilter\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eclass\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EResult\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Einvoke\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EInvoker\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;?&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einvoker\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EInvocation\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERpcException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErpcXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERpcContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetAttachment\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EKEY_XID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisDebugEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Edebug\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;xid in RootContext[&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;] xid in RpcContext[&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErpcXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;]&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebind\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F 如果当前存在 xid 说明是 RPC 发起方, 将 xid 存在 RPC context 中, 它会随着 RPC request 一起发送\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003ERpcContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetAttachment\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EKEY_XID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F 否则他就是 RPC 提供方, 它从 rpc context 中拿到 xid, 并设置到事务 context 中\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErpcXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ebind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErpcXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003Ebind\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisDebugEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Edebug\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;bind[&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErpcXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;] to RootContext&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einvoker\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Einvoke\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Einvocation\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"c1\"\u003E\u002F\u002F 最后清除事务 context 中绑定的 xid, 防止 ThreadLocal 内容污染下次调用\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EunbindXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eunbind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisDebugEnabled\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Edebug\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;unbind[&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EunbindXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;] from RootContext&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(!\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErpcXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EequalsIgnoreCase\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EunbindXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ewarn\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;xid in change during RPC from &#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErpcXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34; to &#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EunbindXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EunbindXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ebind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EunbindXid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"n\"\u003ELOGGER\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ewarn\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;bind [&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EunbindXid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;] back to RootContext&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n                \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E看过我之前发的 \u003Ca href=\"https:\u002F\u002Fzhuanlan.zhihu.com\u002FDubbo\" class=\"internal\"\u003EDubbo\u003C\u002Fa\u003E 文章的同学, 可能还记得 Dubbo 是通过一个 Filter 的概念来表示 AOP 特性的，Filter 的注入基于 Dubbo 的 SPI, 而 Seata 这里所做的就是实现了一个 Dubbo Filter, 把事务 Context 和 RPCContext 中的数据做一下绑定。其他 RPC 框架的支持方案基本类似, 这里就不再赘述了, 值得一提的是, 如果全局事务中的各个微服务是通过 HTTP 请求来互相调用的话, 可以将 XID 存储在 HTTP Header 中, 在官方的提供的 Sample 中有一份样例代码:\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F 实现 servlet filter, 这样服务提供者能从 Http request 中获取 xid 并绑定进事务 Context\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"nd\"\u003E@Component\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ESeataFilter\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFilter\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"nd\"\u003E@Override\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EdoFilter\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EServletRequest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EservletRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EServletResponse\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EservletResponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EFilterChain\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EfilterChain\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIOException\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EServletException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EHttpServletRequest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ereq\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EHttpServletRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EservletRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ereq\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetHeader\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EKEY_XID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EtoLowerCase\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n        \u003Cspan class=\"kt\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EisBind\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EStringUtils\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisNotBlank\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Ebind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EisBind\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Etry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EfilterChain\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EdoFilter\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EservletRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EservletResponse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Efinally\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EisBind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eunbind\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"c1\"\u003E\u002F\u002F 实现 ClientHttpRequestInterceptor, 服务请求方讲 xid 塞入 http request header\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ESeataRestTemplateInterceptor\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EClientHttpRequestInterceptor\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EClientHttpResponse\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Eintercept\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EHttpRequest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EhttpRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Ebyte\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E[]\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebytes\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EClientHttpRequestExecution\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EclientHttpRequestExecution\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Ethrows\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EIOException\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EHttpRequestWrapper\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErequestWrapper\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EHttpRequestWrapper\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EhttpRequest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"n\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetXID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EStringUtils\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EisNotEmpty\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E))\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003ErequestWrapper\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetHeaders\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E().\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERootContext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EKEY_XID\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\n        \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EclientHttpRequestExecution\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eexecute\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErequestWrapper\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebytes\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"c1\"\u003E\u002F\u002F 找到所有 RestTemplate 将 SeataRestTemplateInterceptor 注入\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"nd\"\u003E@Configuration\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ESeataRestTemplateAutoConfiguration\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"nd\"\u003E@Autowired\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Erequired\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ECollection\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERestTemplate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErestTemplates\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"nd\"\u003E@Autowired\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESeataRestTemplateInterceptor\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EseataRestTemplateInterceptor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E;\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"nd\"\u003E@PostConstruct\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kd\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Einit\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ErestTemplates\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n            \u003Cspan class=\"n\"\u003EIterator\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evar1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003ErestTemplates\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eiterator\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n            \u003Cspan class=\"k\"\u003Ewhile\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Evar1\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EhasNext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E())\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E{\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ERestTemplate\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ErestTemplate\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ERestTemplate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evar1\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Enext\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E();\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003EList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EClientHttpRequestInterceptor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Einterceptors\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EArrayList\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ErestTemplate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EgetInterceptors\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E());\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003Einterceptors\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003Eadd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EseataRestTemplateInterceptor\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n                \u003Cspan class=\"n\"\u003ErestTemplate\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"na\"\u003EsetInterceptors\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Einterceptors\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E);\u003C\u002Fspan\u003E\n            \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n        \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"o\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E至此, TM 的重要功能就介绍完了, 值得注意的是事务的传播过程不仅仅是 TM -&gt; RM, RM -&gt; RM 也会进行。接下来, 我们看一看 Seata 两种分支事务类型 AT 和 TCC 的实现方案。\u003C\u002Fp\u003E\u003Ch2\u003E参考内容\u003C\u002Fh2\u003E\u003Cp\u003E[1] \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fwww.jianshu.com\u002Fp\u002F4cb127b737cf\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002Fwww.\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ejianshu.com\u002Fp\u002F4cb127b73\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003E7cf\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[2] \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fmp.weixin.qq.com\u002Fs\u002FEzmZ-DAi-hxJhRkFvFhlJQ\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Emp.weixin.qq.com\u002Fs\u002FEzmZ\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003E-DAi-hxJhRkFvFhlJQ\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[3] \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fmy.oschina.net\u002Fkeking\u002Fblog\u002F3011509\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Emy.oschina.net\u002Fkeking\u002Fb\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003Elog\u002F3011509\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[4] \u003Ca href=\"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F64484721\" class=\"internal\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ezhuanlan.zhihu.com\u002Fp\u002F64\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003E484721\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[5] \u003Ca href=\"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F61981170\" class=\"internal\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ezhuanlan.zhihu.com\u002Fp\u002F61\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003E981170\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[6] \u003Ca href=\"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F78269431\" class=\"internal\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ezhuanlan.zhihu.com\u002Fp\u002F78\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003E269431\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[7] \u003Ca href=\"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F72060852\" class=\"internal\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ezhuanlan.zhihu.com\u002Fp\u002F72\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003E060852\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[8] \u003Ca href=\"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F63552935\" class=\"internal\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ezhuanlan.zhihu.com\u002Fp\u002F63\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003E552935\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[9] \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fwww.bookstack.cn\u002Fread\u002Ffescar-0.4.0\u002Fspilt.1.0.md\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002Fwww.\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ebookstack.cn\u002Fread\u002Ffesca\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003Er-0.4.0\u002Fspilt.1.0.md\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[10] \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fgithub.com\u002Fseata\u002Fseata\u002Fwiki\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Egithub.com\u002Fseata\u002Fseata\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003Ewiki\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp\u003E[11] \u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fjuejin.im\u002Fpost\u002F5caabe29e51d452b1e719265\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003E\u003Cspan class=\"invisible\"\u003Ehttps:\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"visible\"\u003Ejuejin.im\u002Fpost\u002F5caabe29\u003C\u002Fspan\u003E\u003Cspan class=\"invisible\"\u003Ee51d452b1e719265\u003C\u002Fspan\u003E\u003Cspan class=\"ellipsis\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cp class=\"ztext-empty-paragraph\"\u003E\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure data-size=\"normal\"\u003E\u003Cnoscript\u003E\u003Cimg src=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d592b179309467a882e9cbe9a3ce0fcc_b.jpg\" data-rawwidth=\"600\" data-rawheight=\"600\" data-size=\"normal\" class=\"origin_image zh-lightbox-thumb\" width=\"600\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d592b179309467a882e9cbe9a3ce0fcc_r.jpg\"\u002F\u003E\u003C\u002Fnoscript\u003E\u003Cimg src=\"data:image\u002Fsvg+xml;utf8,&lt;svg xmlns=&#39;http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg&#39; width=&#39;600&#39; height=&#39;600&#39;&gt;&lt;\u002Fsvg&gt;\" data-rawwidth=\"600\" data-rawheight=\"600\" data-size=\"normal\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"600\" data-original=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d592b179309467a882e9cbe9a3ce0fcc_r.jpg\" data-actualsrc=\"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-d592b179309467a882e9cbe9a3ce0fcc_b.jpg\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003E\u003C\u002Fp\u003E","adminClosedComment":false,"topics":[{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19802604","type":"topic","id":"19802604","name":"分布式事务"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19561132","type":"topic","id":"19561132","name":"Java"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19593602","type":"topic","id":"19593602","name":"源码阅读"}],"voteupCount":3,"voting":0,"column":{"description":"分享技术经验\n微信公众号：bbm_share\n博客：https:\u002F\u002Fbeikejiedeliulangmao.top\n","canManage":false,"intro":"专注于分享技术经验 公众号:bbm_share","isFollowing":false,"urlToken":"c_1167429588711337985","id":"c_1167429588711337985","articlesCount":51,"acceptSubmission":true,"title":"贝贝猫技术分享","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fc_1167429588711337985","commentPermission":"all","created":1571116903,"updated":1591380653,"imageUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-6c1cd6e6e692b24a81be41c60786bd24_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da.jpg?source=172ae18b","uid":"572701747039047680","userType":"people","isFollowing":false,"urlToken":"beikejiedeliulangmao","id":"7f1731e0c12e7c7a6fa8050e2b727c23","description":"昵称：贝克街的流浪猫（贝贝猫）\n微信公众号：bbm_share\n博客：https:\u002F\u002Fwww.beikejiedeliulangmao.top\nGithub: https:\u002F\u002Fgithub.com\u002FBeiKeJieDeLiuLangMao","name":"贝克街的流浪猫","isAdvertiser":false,"headline":"公众号:bbm_share 分享技术经验","gender":1,"url":"\u002Fpeople\u002F7f1731e0c12e7c7a6fa8050e2b727c23","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":148,"type":"column"},"commentCount":1,"contributions":[{"id":21987595,"state":"accepted","type":"first_publish","column":{"description":"分享技术经验\n微信公众号：bbm_share\n博客：https:\u002F\u002Fbeikejiedeliulangmao.top\n","canManage":false,"intro":"专注于分享技术经验 公众号:bbm_share","isFollowing":false,"urlToken":"c_1167429588711337985","id":"c_1167429588711337985","articlesCount":51,"acceptSubmission":true,"title":"贝贝猫技术分享","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fc_1167429588711337985","commentPermission":"all","created":1571116903,"updated":1591380653,"imageUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-6c1cd6e6e692b24a81be41c60786bd24_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da.jpg?source=172ae18b","uid":"572701747039047680","userType":"people","isFollowing":false,"urlToken":"beikejiedeliulangmao","id":"7f1731e0c12e7c7a6fa8050e2b727c23","description":"昵称：贝克街的流浪猫（贝贝猫）\n微信公众号：bbm_share\n博客：https:\u002F\u002Fwww.beikejiedeliulangmao.top\nGithub: https:\u002F\u002Fgithub.com\u002FBeiKeJieDeLiuLangMao","name":"贝克街的流浪猫","isAdvertiser":false,"headline":"公众号:bbm_share 分享技术经验","gender":1,"url":"\u002Fpeople\u002F7f1731e0c12e7c7a6fa8050e2b727c23","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":148,"type":"column"}}],"isTitleImageFullScreen":false,"upvotedFollowees":[],"commercialInfo":{"isCommercial":false,"plugin":{}},"suggestEdit":{"status":false,"reason":"","tip":"","url":"","title":""},"reason":"","annotationAction":[],"canTip":true,"tipjarorsCount":0,"isLabeled":false,"hasPublishingDraft":false,"isFavorited":false,"isNormal":true,"status":0,"shareText":"Seata 源码剖析之 TC TM - 来自知乎专栏「贝贝猫技术分享」，作者: 贝克街的流浪猫 https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F87100741 （想看更多？下载 @知乎 App：http:\u002F\u002Fweibo.com\u002Fp\u002F100404711598 ）","canComment":{"status":true,"reason":""},"mcnFpShow":-1,"isVisible":true,"isLiked":false,"likedCount":0,"visibleOnlyToAuthor":false,"hasColumn":true,"republishers":[]}},"columns":{"c_1167429588711337985":{"description":"分享技术经验\n微信公众号：bbm_share\n博客：https:\u002F\u002Fbeikejiedeliulangmao.top\n","canManage":false,"intro":"专注于分享技术经验 公众号:bbm_share","isFollowing":false,"urlToken":"c_1167429588711337985","id":"c_1167429588711337985","articlesCount":51,"acceptSubmission":true,"title":"贝贝猫技术分享","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fc_1167429588711337985","commentPermission":"all","created":1571116903,"updated":1591380653,"imageUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-6c1cd6e6e692b24a81be41c60786bd24_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da.jpg?source=172ae18b","uid":"572701747039047680","userType":"people","isFollowing":false,"urlToken":"beikejiedeliulangmao","id":"7f1731e0c12e7c7a6fa8050e2b727c23","description":"昵称：贝克街的流浪猫（贝贝猫）\n微信公众号：bbm_share\n博客：https:\u002F\u002Fwww.beikejiedeliulangmao.top\nGithub: https:\u002F\u002Fgithub.com\u002FBeiKeJieDeLiuLangMao","name":"贝克街的流浪猫","isAdvertiser":false,"headline":"公众号:bbm_share 分享技术经验","gender":1,"url":"\u002Fpeople\u002F7f1731e0c12e7c7a6fa8050e2b727c23","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-862f47c1c2624aacea89180adb8398da_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":148,"type":"column"}},"topics":{},"roundtables":{},"favlists":{},"comments":{},"notifications":{},"ebooks":{},"activities":{},"feeds":{},"pins":{},"promotions":{},"drafts":{},"chats":{},"posts":{},"clubs":{},"clubTags":{}},"currentUser":"","account":{"lockLevel":{},"unlockTicketStatus":false,"unlockTicket":null,"challenge":[],"errorStatus":false,"message":"","isFetching":false,"accountInfo":{},"urlToken":{"loading":false}},"settings":{"socialBind":null,"inboxMsg":null,"notification":{},"email":{},"privacyFlag":null,"blockedUsers":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"blockedFollowees":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"ignoredTopics":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"restrictedTopics":null,"laboratory":{}},"notification":{},"people":{"profileStatus":{},"activitiesByUser":{},"answersByUser":{},"answersSortByVotesByUser":{},"answersIncludedByUser":{},"votedAnswersByUser":{},"thankedAnswersByUser":{},"voteAnswersByUser":{},"thankAnswersByUser":{},"topicAnswersByUser":{},"zvideosByUser":{},"articlesByUser":{},"articlesSortByVotesByUser":{},"articlesIncludedByUser":{},"pinsByUser":{},"questionsByUser":{},"commercialQuestionsByUser":{},"favlistsByUser":{},"followingByUser":{},"followersByUser":{},"mutualsByUser":{},"followingColumnsByUser":{},"followingQuestionsByUser":{},"followingFavlistsByUser":{},"followingTopicsByUser":{},"publicationsByUser":{},"columnsByUser":{},"allFavlistsByUser":{},"brands":null,"creationsByUser":{},"creationsSortByVotesByUser":{},"creationsFeed":{},"infinity":{}},"env":{"ab":{"config":{"experiments":[{"expId":"launch-qa_cl_guest-2","expPrefix":"qa_cl_guest","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-us_foltopic_user-10","expPrefix":"us_foltopic_user","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_bullet_second-2","expPrefix":"vd_bullet_second","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_profile_video-11","expPrefix":"vd_profile_video","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_sharpness-3","expPrefix":"vd_sharpness","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_timeguide-2","expPrefix":"vd_timeguide","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_video_replay-3","expPrefix":"vd_video_replay","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_zvideo_link-10","expPrefix":"vd_zvideo_link","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"vd_bullet_gui-2","expPrefix":"vd_bullet_gui","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"se_topicfeed-1","expPrefix":"se_topicfeed","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false}],"params":[{"id":"li_svip_tab_search","type":"String","value":"1","chainId":"_all_","layerId":"lili_layer_1"},{"id":"se_club_ui","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_581"},{"id":"gue_q_share","type":"String","value":"0","layerId":"gueqa_layer_647"},{"id":"gue_fo_recom","type":"String","value":"0","layerId":"gueqa_layer_780"},{"id":"ge_club_ai","type":"String","value":"0","chainId":"_gene_","layerId":"getp_layer_882","key":2950},{"id":"pf_profile2_tab","type":"String","value":"0","chainId":"_all_","layerId":"pfus_layer_601"},{"id":"web_answerlist_ad","type":"String","value":"0","layerId":"webqa_layer_1"},{"id":"zw_sameq_sorce","type":"String","value":"999","chainId":"_all_","layerId":"zwqa_layer_2"},{"id":"ge_com_sup","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_859","key":2891},{"id":"tp_contents","type":"String","value":"2","chainId":"_all_","layerId":"tptp_layer_627"},{"id":"gue_repost","type":"String","value":"0","layerId":"gueqa_layer_671"},{"id":"tp_fenqu_wei","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_626"},{"id":"web_pcleft","type":"String","value":"0","layerId":"webtop_layer_701"},{"id":"gue_profile_video","type":"String","value":"1","layerId":"guevd_layer_5"},{"id":"li_viptab_name","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_0"},{"id":"gue_visit_n_artcard","type":"String","value":"1","layerId":"gueqa_layer_579"},{"id":"web_column_auto_invite","type":"String","value":"0","layerId":"webqa_layer_1"},{"id":"tp_discover","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_3"},{"id":"tp_topic_tab_new","type":"String","value":"0-0-0","chainId":"_all_","layerId":"tptp_layer_3"},{"id":"web_ad_banner","type":"String","value":"0","layerId":"webgw_layer_3"},{"id":"gue_push2follow","type":"String","value":"1","layerId":"gueqa_layer_3"},{"id":"qap_labeltype","type":"String","value":"1","chainId":"_all_","layerId":"qapqa_layer_1"},{"id":"web_audit_01","type":"String","value":"case1","layerId":"webre_layer_1"},{"id":"se_entity22","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_26"},{"id":"ge_jqyd1","type":"String","value":"0","chainId":"_gene_","layerId":"getp_layer_827","key":2930},{"id":"ge_qngz1","type":"String","value":"1","chainId":"_gene_","layerId":"getp_layer_827","key":2797},{"id":"li_yxzl_new_style_a","type":"String","value":"1","chainId":"_all_","layerId":"lili_layer_607"},{"id":"gue_art_ui","type":"String","value":"0","layerId":"gueqa_layer_671"},{"id":"web_table","type":"String","value":"0","layerId":"webqa_layer_862"},{"id":"ge_usercard1","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_742","key":2740},{"id":"ge_v062","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_858","key":2863},{"id":"tp_clubhyb","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_619"},{"id":"pf_newguide_vertical","type":"String","value":"0","chainId":"_all_","layerId":"pfus_layer_4"},{"id":"gue_v_serial","type":"String","value":"1","layerId":"guevd_layer_695"},{"id":"zr_intervene","type":"String","value":"0","chainId":"_all_","layerId":"zrrec_layer_2"},{"id":"gue_repost1","type":"String","value":"1","layerId":"guere_layer_819"},{"id":"gue_bulletmb","type":"String","value":"0","layerId":"guevd_layer_812"},{"id":"web_unfriendly_comm","type":"String","value":"0","layerId":"webre_layer_1"},{"id":"ge_upload","type":"String","value":"0","chainId":"_gene_","layerId":"geus_layer_839","key":2892},{"id":"qap_question_author","type":"String","value":"0","chainId":"_all_","layerId":"qapqa_layer_2"},{"id":"ge_ltr_v1","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_904","key":2873},{"id":"ge_club_feed","type":"String","value":"0","chainId":"_gene_","layerId":"getp_layer_882","key":2882},{"id":"gue_art2qa","type":"String","value":"0","layerId":"gueqa_layer_579"},{"id":"ge_newyanzhi","type":"String","value":"0","chainId":"_gene_","layerId":"geus_layer_839","key":2788},{"id":"gue_video_guide","type":"String","value":"1","layerId":"guevd_layer_625"},{"id":"se_whitelist","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_2"},{"id":"ge_flow_ai","type":"String","value":"0","chainId":"_gene_","layerId":"getp_layer_872","key":2872},{"id":"web_heifetz_grow_ad","type":"String","value":"1","layerId":"webgw_layer_3"},{"id":"web_img_up","type":"String","value":"0","layerId":"webqa_layer_862"},{"id":"zr_sim3","type":"String","value":"0","chainId":"_all_","layerId":"zrrec_layer_756"},{"id":"se_usercard","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_581"},{"id":"li_catalog_card","type":"String","value":"1","chainId":"_all_","layerId":"lili_layer_11"},{"id":"soc_notification","type":"String","value":"1","chainId":"_all_","layerId":"socus_layer_4"},{"id":"ug_newtag","type":"String","value":"1","chainId":"_all_","layerId":"ugus_layer_4"},{"id":"li_sp_mqbk","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_748"},{"id":"gue_q_intercept","type":"String","value":"0","layerId":"gueqa_layer_2"},{"id":"pf_creator_card","type":"String","value":"1","chainId":"_all_","layerId":"pfus_layer_1"},{"id":"ge_video","type":"String","value":"0","chainId":"_gene_","layerId":"geli_layer_856","key":2831},{"id":"zr_rec_answer_cp","type":"String","value":"open","chainId":"_all_","layerId":"zrrec_layer_2"},{"id":"tp_dingyue_video","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_4"},{"id":"gue_video_replay","type":"String","value":"2","layerId":"guevd_layer_3"},{"id":"web_sem_ab","type":"String","value":"1","layerId":"webgw_layer_3"},{"id":"ge_club_pin","type":"String","value":"1","chainId":"_gene_","layerId":"getp_layer_881","key":2775},{"id":"li_paid_answer_exp","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_3"},{"id":"gue_recmess","type":"String","value":"0","layerId":"gueqa_layer_795"},{"id":"tp_topic_tab","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_1"},{"id":"top_test_4_liguangyi","type":"String","value":"1","chainId":"_all_","layerId":"iosus_layer_1"},{"id":"gue_zvideo_link","type":"String","value":"1","layerId":"guevd_layer_2"},{"id":"web_scl_rec","type":"String","value":"0","layerId":"webgw_layer_759"},{"id":"se_col_boost","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_11"},{"id":"gue_bullet_guide","type":"String","value":"分享你刚编的弹幕","layerId":"guevd_layer_0"},{"id":"gue_cdzixun","type":"String","value":"0","layerId":"gueqa_layer_3"},{"id":"ge_infinity6","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_815","key":2817},{"id":"ge_relation2","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_815","key":2796},{"id":"se_guess","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_623"},{"id":"li_panswer_topic","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_602"},{"id":"gue_article_sicon","type":"String","value":"0","layerId":"gueqa_layer_647"},{"id":"qap_question_visitor","type":"String","value":" 0","chainId":"_all_","layerId":"qapqa_layer_2"},{"id":"zr_slot_training","type":"String","value":"1","chainId":"_all_","layerId":"zrrec_layer_1"},{"id":"ge_social_v2","type":"String","value":"2","chainId":"_gene_","layerId":"gese_layer_858","key":2795},{"id":"web_answer_list_ad","type":"String","value":"1","layerId":"webqa_layer_4"},{"id":"web_collection_guest","type":"String","value":"1","layerId":"webqa_layer_4"},{"id":"zr_slotpaidexp","type":"String","value":"1","chainId":"_all_","layerId":"zrrec_layer_5"},{"id":"se_college","type":"String","value":"default","chainId":"_all_","layerId":"sese_layer_2"},{"id":"web_creator_route","type":"String","value":"1","layerId":"webtop_layer_1"},{"id":"li_car_meta","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_0"},{"id":"gue_share_icon","type":"String","value":"0","layerId":"gueqa_layer_647"},{"id":"gue_bullet_second","type":"String","value":"1","layerId":"guevd_layer_1"},{"id":"ls_video_commercial","type":"String","value":"0","chainId":"_all_","layerId":"lsvd_layer_7"},{"id":"li_ebook_gen_search","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_10"},{"id":"li_video_section","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_7"},{"id":"gue_self_censoring","type":"String","value":"1","layerId":"gueqa_layer_1"},{"id":"zr_expslotpaid","type":"String","value":"1","chainId":"_all_","layerId":"zrrec_layer_11"},{"id":"ge_return","type":"String","value":"1","chainId":"_gene_","layerId":"gese_layer_788","key":2856},{"id":"pf_adjust","type":"String","value":"0","chainId":"_all_","layerId":"pfus_layer_9"},{"id":"gue_card_test","type":"String","value":"1","layerId":"gueqa_layer_2"},{"id":"ge_guess","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_859","key":2912},{"id":"ge_rm_d2q","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_859","key":2834},{"id":"tp_zrec","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_619"},{"id":"pf_noti_entry_num","type":"String","value":"0","chainId":"_all_","layerId":"pfus_layer_718"},{"id":"se_colorfultab","type":"String","value":"1","chainId":"_all_","layerId":"sese_layer_2"},{"id":"tp_topic_style","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_4"},{"id":"pf_fuceng","type":"String","value":"1","chainId":"_all_","layerId":"pfus_layer_2"},{"id":"gue_zvideo_title","type":"String","value":"0","layerId":"guevd_layer_559"},{"id":"gue_vid_tab","type":"String","value":"0","layerId":"guevd_layer_900"},{"id":"ge_ym_xjym","type":"String","value":"0","chainId":"_gene_","layerId":"geli_layer_856","key":2919},{"id":"gue_art_sani","type":"String","value":"0","layerId":"gueqa_layer_647"},{"id":"ge_vip_cont","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_742","key":2828},{"id":"tsp_hotlist_ui","type":"String","value":"1","chainId":"_all_","layerId":"tsptop_layer_1"},{"id":"pf_foltopic_usernum","type":"String","value":"50","chainId":"_all_","layerId":"pfus_layer_5"},{"id":"ge_ge01","type":"String","value":"5","chainId":"_gene_","layerId":"gese_layer_742","key":2597},{"id":"ge_sug_dnn","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_834","key":2878},{"id":"se_topicfeed","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_12"},{"id":"se_ffzx_jushen1","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_4"},{"id":"gue_goods_card","type":"String","value":"0","layerId":"gueqa_layer_1"},{"id":"ge_search_ui","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_838","key":2898},{"id":"ge_v_rank_v2","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_904","key":2904},{"id":"web_login","type":"String","value":"0","layerId":"webgw_layer_759"},{"id":"li_svip_cardshow","type":"String","value":"1","chainId":"_all_","layerId":"lili_layer_0"},{"id":"li_topics_search","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_0"},{"id":"li_vip_verti_search","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_2"},{"id":"li_pl_xj","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_580"},{"id":"li_edu_page","type":"String","value":"old","chainId":"_all_","layerId":"lili_layer_580"},{"id":"gue_sharp","type":"String","value":"1","layerId":"guevd_layer_686"},{"id":"web_qxd_pc","type":"String","value":"0","layerId":"webqa_layer_929"},{"id":"ge_ge02","type":"String","value":"6","chainId":"_gene_","layerId":"gese_layer_742","key":2599},{"id":"ge_qnfd","type":"String","value":"1","chainId":"_gene_","layerId":"getp_layer_872","key":2858},{"id":"ug_follow_topic_1","type":"String","value":"2","chainId":"_all_","layerId":"ugus_layer_3"},{"id":"gue_messrec","type":"String","value":"0","layerId":"gueqa_layer_769"}],"chains":[{"chainId":"_all_"}],"encodedParams":"CjaGC0sLcgvtCrQKLwtMCzkLQgvkCjgLDwvXCgEL7ArrCigLYAsSC2cLDAslCj4LUgtYCycKKgsSGwAAAAEAAAAAAAAAAAEAAAIBAAAAAAUAAAAGAQ=="},"triggers":{}},"userAgent":{"Edge":false,"Wechat":false,"Weibo":false,"QQ":false,"MQQBrowser":false,"Qzone":false,"Mobile":false,"Android":false,"iOS":false,"isAppleDevice":false,"Zhihu":false,"ZhihuHybrid":false,"isBot":false,"Tablet":false,"UC":false,"Sogou":false,"Qihoo":false,"Baidu":false,"BaiduApp":false,"Safari":false,"GoogleBot":false,"AndroidDaily":false,"iOSDaily":false,"WxMiniProgram":false,"BaiduMiniProgram":false,"QQMiniProgram":false,"JDMiniProgram":false,"isWebView":false,"isMiniProgram":false,"origin":"Mozilla\u002F5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko\u002F20100101 Firefox\u002F80.0"},"appViewConfig":{},"ctx":{"path":"\u002Fp\u002F87100741","query":{},"href":"http:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F87100741","host":"zhuanlan.zhihu.com"},"trafficSource":"production","edition":{"beijing":false,"baidu":true,"sogou":false,"baiduBeijing":false,"sogouBeijing":false,"sogouInput":false,"baiduSearch":true,"googleSearch":false,"miniProgram":false,"xiaomi":false},"theme":"light","enableShortcut":true,"referer":"https:\u002F\u002Fwww.baidu.com\u002Flink?url=VvyfamJxfZdC5PVoGuygYhdffqkxBZWOy2E3ExlCVZs0UQ0Hqcn0FnnIj32eBfpz&wd=&eqid=da5765bb000d9d85000000035f6767ea","conf":{},"xTrafficFreeOrigin":"","ipInfo":{"cityName":"杭州","countryName":"中国","regionName":"浙江","countryCode":"CN"},"logged":false},"me":{"columnContributions":[]},"label":{"recognizerLists":{}},"ecommerce":{},"comments":{"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"parent":{}},"commentsV2":{"stickers":[],"commentWithPicPermission":{},"notificationsComments":{},"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"conversationMore":{},"parent":{}},"pushNotifications":{"default":{"isFetching":false,"isDrained":false,"ids":[]},"follow":{"isFetching":false,"isDrained":false,"ids":[]},"vote_thank":{"isFetching":false,"isDrained":false,"ids":[]},"currentTab":"default","notificationsCount":{"default":0,"follow":0,"vote_thank":0}},"messages":{"data":{},"currentTab":"common","messageCount":0},"register":{"registerValidateSucceeded":null,"registerValidateErrors":{},"registerConfirmError":null,"sendDigitsError":null,"registerConfirmSucceeded":null},"login":{"loginUnregisteredError":false,"loginBindWechatError":false,"loginConfirmError":null,"sendDigitsError":null,"needSMSIdentify":false,"validateDigitsError":false,"loginConfirmSucceeded":null,"qrcodeLoginToken":"","qrcodeLoginScanStatus":0,"qrcodeLoginError":null,"qrcodeLoginReturnNewToken":false},"active":{"sendDigitsError":null,"activeConfirmSucceeded":null,"activeConfirmError":null},"switches":{},"captcha":{"captchaNeeded":false,"captchaValidated":false,"captchaBase64String":null,"captchaValidationMessage":null,"loginCaptchaExpires":false},"sms":{"supportedCountries":[]},"chat":{"chats":{},"inbox":{"recents":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"strangers":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"friends":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"search":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"config":{"newCount":0,"strangerMessageSwitch":false,"strangerMessageUnread":false,"friendCount":0}},"global":{"isChatMqttExisted":false}},"emoticons":{"emoticonGroupList":[],"emoticonGroupDetail":{}},"creator":{"currentCreatorUrlToken":null,"homeData":{"recommendQuestions":[]},"tools":{"question":{"invitationCount":{"questionFolloweeCount":0,"questionTotalCount":0},"goodatTopics":[]},"customPromotion":{"itemLists":{}},"recommend":{"recommendTimes":{}}},"explore":{"academy":{"tabs":[],"article":{}}},"rights":[],"rightsStatus":{},"levelUpperLimit":10,"account":{"growthLevel":{}},"mcn":{},"applyStatus":{},"videoSupport":{}},"answers":{"voters":{},"copyrightApplicants":{},"favlists":{},"newAnswer":{},"concernedUpvoters":{},"simpleConcernedUpvoters":{},"paidContent":{},"settings":{}},"recommendation":{"homeRecommendations":[]},"shareTexts":{},"articles":{"voters":{}},"previewPost":{},"favlists":{"relations":{}},"columns":{"voters":{}},"reward":{"answer":{},"article":{},"question":{}},"video":{"data":{},"shareVideoDetail":{},"last":{}},"topstory":{"recommend":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"follow":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"room":{"meta":{},"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"followWonderful":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"sidebar":null,"announcement":{},"hotListCategories":[],"hotList":[],"guestFeeds":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"followExtra":{"isNewUser":null,"isFetched":false,"followCount":0,"followers":[]}},"readStatus":{},"column":{},"requestColumn":{"categories":[],"error":null},"articleContribution":{"contributeRequests":[],"deleteContributeIdList":[],"handledContributeIdList":[],"recommendedColumns":[],"pinnedColumns":[],"sentContributeRequestsIdList":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"c_1167429588711337985"]},"columnContribution":{"contributeRequests":[],"autoInviteEnabled":false,"recommendedContributors":[],"contributionInvitation":null},"draftHistory":{"history":{},"drafts":{}},"upload":{},"articleDraft":{"titleImage":"","titleImageSize":{},"isTitleImageFullScreen":false,"canTitleImageFullScreen":false,"title":"","titleImageUploading":false,"error":"","content":"","draftLoading":false,"updating":false,"globalLoading":false,"pendingVideo":{"resource":null,"error":null},"deleteFail":{"fail":false},"recommendTopics":[],"selectedColumn":0,"articleDisclaimers":[]},"articleDrafts":{"isDrained":false,"isLoading":false,"items":[]},"columnAutocomplete":{"users":[],"friends":[]},"columnCollection":{},"userProfit":{"permission":{"permissionStatus":{"zhiZixuan":0,"recommend":-1,"task":0,"plugin":0},"visible":false}},"mcn":{"bindInfo":{},"memberCategoryList":[],"producerList":[],"categoryList":[],"lists":{},"banners":{}},"zvideos":{"campaigns":{},"tagoreCategory":[],"recommendations":{},"insertable":{},"recruit":{"form":{"platform":"","nickname":"","followerCount":"","domain":"","contact":""},"submited":false,"ranking":[]},"club":{}},"republish":{}},"fetchHost":"www.zhihu.com","subAppName":"column"}</script><script src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/vendor.js"></script><script src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/column_003.js"></script><script src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/hm.js" async=""></script><script src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/zap.js"></script><script src="Seata%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E4%B9%8B%20TC%20TM%20-%20%E7%9F%A5%E4%B9%8E_files/push.js"></script><div><div style="display: none;">想来知乎工作？请发送邮件到 jobs@zhihu.com</div></div><div><div><div class="css-8pdeid"></div></div></div><div><div><div style="left: -1179px; top: -999px;" class="Editable-languageSuggestions"><div><div class="Popover"><label class="Editable-languageSuggestionsInput Input-wrapper"><input autocomplete="off" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-activedescendant="AutoComplete12-0" id="Popover11-toggle" aria-haspopup="true" aria-owns="Popover11-content" class="Input" placeholder="选择语言"><svg class="Zi Zi--Select" fill="#afbdcf" viewBox="0 0 24 24" width="24" height="24"><path d="M12 16.183l2.716-2.966a.757.757 0 0 1 1.064.001.738.738 0 0 1 0 1.052l-3.247 3.512a.758.758 0 0 1-1.064 0L8.22 14.27a.738.738 0 0 1 0-1.052.758.758 0 0 1 1.063 0L12 16.183zm0-9.365L9.284 9.782a.758.758 0 0 1-1.064 0 .738.738 0 0 1 0-1.052l3.248-3.512a.758.758 0 0 1 1.065 0L15.78 8.73a.738.738 0 0 1 0 1.052.757.757 0 0 1-1.063.001L12 6.818z" fill-rule="evenodd"></path></svg></label></div></div></div></div></div></body></html>